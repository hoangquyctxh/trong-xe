<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác nhận xe ra</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script> <!-- MỚI: Tải file cấu hình -->
    <style>
        :root {
            /* --- BẢNG MÀU ĐỒNG BỘ TỪ INDEX.HTML (PHIÊN BẢN HOÀN CHỈNH) --- */
            --bg-main: #f8f9fa; /* Nền chính sáng hơn, sạch sẽ hơn */
            --bg-card: #ffffff;
            --border-color: #dee2e6;
            --primary-accent: #0056b3; /* Xanh đậm, sang trọng hơn */
            --primary-accent-light: #007bff;
            --text-primary: #111827;
            --text-secondary: #4b5567;
            --danger-color: #dc3545;
            --success-color: #28a745;
            /* --- Hiệu ứng đổ bóng & bo góc đồng bộ --- */
            --transition-fast: all 0.2s ease-in-out;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.075);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.1);
            --border-radius-lg: 1rem;
            --border-radius-md: 0.375rem;
        }
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            box-sizing: border-box;
        }
        /* --- GIAO DIỆN CHUNG --- */
        .confirmation-card {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px; /* Tăng độ rộng tối đa cho bố cục ngang */
            padding: 2.5em;
            border: 1px solid var(--border-color);
            position: relative;
            text-align: center;
            animation: fadeIn 0.4s ease-out;
        }
        .confirmation-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 5px;
            background: var(--primary-accent);
        }
        #success-view .confirmation-card::after {
            background: var(--success-color);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to   { opacity: 1; transform: scale(1); }
        }
        .card-title {
            color: var(--primary-accent);
            font-size: 2rem; /* Giảm nhẹ */
            margin-bottom: 0.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 800;
        }
        .card-title.success {
            color: var(--success-color);
        }

        /* --- HIỆU ỨNG CHO ICON THÀNH CÔNG --- */
        .success-icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 1em auto;
        }
        .success-checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 3;
            stroke: white;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px var(--success-color);
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .success-checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 3;
            stroke-miterlimit: 10;
            stroke: var(--success-color);
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .success-checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; } } @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } } @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 40px var(--success-color); }
        }
        .info-grid {
            margin-top: 2em;
            display: flex;
            flex-direction: column;
            gap: 1em;
            text-align: left;
            font-size: 1.1rem;
            border-top: 1px dashed var(--border-color);
            padding-top: 2em;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .info-item .label {
            color: var(--text-secondary);
        }
        .info-item .value {
            font-weight: 700;
        }
        .total-amount-value {
            color: var(--danger-color);
            font-size: 1.2em;
        }
        .hidden { display: none !important; }
        .total-fee-container .label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* --- GIAO DIỆN CHỌN THANH TOÁN --- */
        /* ================================================== */
        /* --- REDESIGN: KHU VỰC TỔNG PHÍ - TOP 1 --- */
        /* ================================================== */
        .total-fee-container {
            background: linear-gradient(180deg, rgba(220, 53, 69, 0.05), transparent);
            border: 1px solid rgba(220, 53, 69, 0.15);
            border-radius: var(--border-radius-lg);
            padding: 1.5em 2em;
            margin-bottom: 2em;
            animation: fadeInFee 0.5s 0.2s ease-out backwards;
        }
        @keyframes fadeInFee {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        
        .total-fee-container .amount {
            font-size: 4rem;
            font-weight: 800;
            color: var(--danger-color);
            line-height: 1;
            margin-top: 0.2em;
            animation: popInAmount 0.6s 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) backwards;
        }
        @keyframes popInAmount {
            from { opacity: 0; transform: scale(0.8); }
            to   { opacity: 1; transform: scale(1); }
        }
        .total-fee-container .amount sup {
            font-size: 2rem; /* Tăng kích thước đơn vị tiền tệ */
            font-weight: 700;
            vertical-align: top;
        }

        /* ================================================== */
        /* --- BỐ CỤC NGANG MỚI - TOP 1 --- */
        /* ================================================== */
        .payment-content-grid {
            display: grid;
            /* NÂNG CẤP: Bắt đầu với 1 cột, sẽ chuyển thành 2 cột bằng JS */
            grid-template-columns: 1fr;
            justify-items: center; /* Căn giữa nội dung ban đầu */
            gap: 2.5em;
            align-items: start; /* Căn các cột theo đỉnh */
            margin-top: 1.5em;
            transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1); /* Hiệu ứng chuyển đổi layout */
        }
        /* NÂNG CẤP: Trạng thái 2 cột khi đã chọn phương thức thanh toán */
        .payment-content-grid.method-selected {
            grid-template-columns: 1fr 1fr;
            justify-items: initial; /* Reset về mặc định */
        }
        .payment-details-panel {
            display: flex;
            flex-direction: column;
            width: 100%; /* Đảm bảo panel chiếm đủ không gian */
            transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1); /* Hiệu ứng trượt */
            transform: translateX(0);
        }
        /* NÂNG CẤP: Hiệu ứng trượt sang trái */
        .payment-content-grid.method-selected .payment-details-panel {
            transform: translateX(0);
        }
        .payment-qr-panel {
            background-color: var(--bg-main);
            border-radius: var(--border-radius-lg);
            padding: 2em;
            border: 1px solid var(--border-color);
            min-height: 420px; /* Tăng chiều cao để cân đối */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            transition: all 0.5s ease 0.2s; /* Thêm delay để xuất hiện sau khi layout thay đổi */
            opacity: 0; /* Ẩn ban đầu */
            transform: scale(0.95);
            display: none; /* Ẩn hoàn toàn ban đầu */
        }
        /* NÂNG CẤP: Hiệu ứng xuất hiện cho panel bên phải */
        .payment-content-grid.method-selected .payment-qr-panel {
            display: flex; /* Hiện lại khi cần */
            opacity: 1;
            transform: scale(1);
        }
        .payment-qr-panel.placeholder {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .payment-method-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1em;
            margin-bottom: 2em; /* Tăng khoảng cách */
        }
        .qr-code-display {
            padding: 15px;
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); /* Bo góc lớn hơn cho đẹp */
            max-width: 280px;
            margin: 0 auto;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 1;
            transform: translateY(0);
        }
        .qr-code-display img {
            width: 100%;
            height: auto;
            display: block;
        }
        .qr-code-display p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
            word-break: break-all;
        }
        .qr-code-display strong {
            font-family: monospace;
            color: var(--text-primary);
        }
        .qr-code-display.hidden {
            opacity: 0;
            transform: translateY(10px);
            height: 0;
            padding: 0; margin: 0; overflow: hidden;
        }
        /* MỚI: Bố cục hiển thị thông tin chính */
        .main-info-display {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5em;
            margin-bottom: 1.5em;
        }
        .main-info-display .plate-display { /* Giảm kích thước biển số */
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--primary-accent);
            font-family: monospace;
            line-height: 1.1;
        }
        .main-info-display .time-in-display {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-top: 0.5em;
        }
        /* --- NÚT HÀNH ĐỘNG --- */
        .action-buttons {
            margin-top: 2em;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5em;
        }
        .btn {
            display: inline-block;
            width: 100%;
            padding: 0.8em 1em;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
        }
        .btn-primary {
            background-color: var(--primary-accent);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-accent-light);
            box-shadow: var(--shadow-md);
        }
        .auto-close-note {
            margin-top: 1.5em; font-size: 0.9rem; color: var(--text-secondary);
        }

        /* --- MỚI: Header phụ cho trang --- */
        .aux-header {
            display: flex;
            align-items: center;
            justify-content: space-between; /* MỚI: Đẩy các phần tử ra hai bên */
            gap: 18px; /* Tăng khoảng cách */
            margin-bottom: 2em; /* Tạo khoảng cách với tiêu đề chính */
            padding-bottom: 1.5em;
            border-bottom: 1px dashed var(--border-color);
        }
        .aux-header .logo {
            width: 55px;  /* Tăng kích thước logo */
            height: 55px; /* Tăng kích thước logo */
        }
        .aux-header .org-name {
            font-size: 1.1rem; /* Tăng kích thước chữ */
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            line-height: 1.4;
            text-align: left;
        }
        /* MỚI: Nhóm các phần tử bên trái */
        .header-left {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        /* MỚI: Phần thông tin điểm trực bên phải */
        .location-info {
            text-align: right;
        }
        .location-info .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: block;
        }
        .location-info .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-accent);
        }

        /* ================================================== */
        /* --- REDESIGN: GIAO DIỆN THÀNH CÔNG - TOP 1 --- */
        /* ================================================== */
        #success-view .card-title { animation: fadeInDown 0.5s 1s backwards; }

        .success-main-content {
            animation: fadeIn 0.5s 1.2s backwards;
        }

        .success-amount-display {
            margin: 0.5em 0;
        }
        .success-amount-display .label {
            font-size: 1.3rem; /* Giảm nhẹ */
            color: var(--text-secondary);
            animation: fadeInUp 0.5s 1.4s backwards;
        }
        .success-amount-display .amount { /* Tăng cỡ chữ */
            font-size: 4.2rem;
            font-weight: 800;
            color: var(--success-color);
            line-height: 1.1;
            animation: popInAmount 0.6s 1.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) backwards;
        }
        .success-amount-display .amount sup { /* Tăng cỡ chữ */
            font-size: 2rem;
            font-weight: 700;
        }

        .success-plate-display { /* Tăng cỡ chữ */
            font-size: 2.8rem;
            font-weight: 700;
            font-family: monospace;
            color: var(--text-primary);
            background: var(--bg-main);
            padding: 10px 25px;
            border-radius: var(--border-radius-md);
            display: inline-block;
            border: 1px solid var(--border-color);
            margin-top: 0.5em; /* Giảm khoảng cách */
            animation: fadeInUp 0.5s 1.8s backwards;
        }

        /* ================================================== */
        /* --- MỚI: TÁI CẤU TRÚC CHI TIẾT THANH TOÁN --- */
        /* ================================================== */
        .success-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5em 2em; /* Giảm nữa */
            margin-top: 1.2em; /* Giảm nữa */
            padding: 1em 1.5em; /* Giảm nữa */
            background: var(--bg-main);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            text-align: left;
            animation: fadeInUp 0.5s 2s backwards;
        }
        .success-details-grid .detail-item {
            font-size: 1.15rem; /* Tăng cỡ chữ */
        }
        .success-details-grid .detail-item .label {
            color: var(--text-secondary);
            display: block;
            font-size: 0.9rem;
        }
        .success-details-grid .detail-item .value {
            font-weight: 700;
            color: var(--text-primary);
        }
        .success-duration-highlight {
            grid-column: 1 / -1; /* Trải dài toàn bộ grid */
            text-align: center;
            margin-top: 0.8em;
            padding-top: 0.8em;
            border-top: 1px dashed var(--border-color);
        }
        .success-duration-highlight .label {
            font-size: 1.1rem;
        }
        .success-duration-highlight .value {
            font-size: 1.8rem; /* Tăng cỡ chữ */
            font-weight: 800;
            color: var(--primary-accent);
        }

        .thank-you-message {
            margin-top: 1em; /* Giảm nữa */
            font-size: 1.4rem; /* Tăng cỡ chữ */
            font-weight: 700;
            color: var(--text-secondary);
            animation: fadeInUp 0.5s 2.2s backwards;
        }

        /* ================================================== */
        /* --- MỚI: GIAO DIỆN MÀN HÌNH CHỜ (IDLE) --- */
        /* ================================================== */
        #idle-view .confirmation-card::after {
            background: var(--primary-accent);
        }
        .idle-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        .idle-org-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 1.5em;
        }
        /* MỚI: CSS cho tên điểm trực ở màn hình chờ */
        .idle-location-name {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: -1em; /* Kéo lên gần hơn */
            margin-bottom: 1.5em;
        }
        .idle-location-name strong {
            color: var(--primary-accent);
        }
        .idle-logo {
            width: 120px;
            height: 120px;
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        .idle-title {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--primary-accent);
            margin-top: 1.5em;
            line-height: 1.3;
        }
        .idle-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-top: 1em;
        }
        /* MỚI: CSS cho widget thời tiết & đồng hồ */
        .idle-widgets { /* Làm to rõ hơn */
            display: flex;
            gap: 20px;
            margin-top: 2.5em; /* Đặt ngay dưới nội dung chính */
        }
        .clock-widget, .weather-widget { /* Làm to rõ hơn */
            display: flex; align-items: center; gap: 8px;
            background: var(--bg-main);
            padding: 12px 18px;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        .clock-widget .icon, #weather-icon { color: var(--primary-accent); width: 28px; height: 28px; }
        #clock-display { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        #weather-temp { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        #weather-icon { height: 28px; width: auto; }

        /* ================================================== */
        /* --- MỚI: DÒNG CHỮ CHẠY & ĐỒNG HỒ GÓC PHẢI --- */
        /* ================================================== */
        .idle-footer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px; /* Tăng chiều cao để chứa logo lớn hơn */
            background: rgba(0, 0, 0, 0.4);
            display: flex; /* Sẽ được dùng trong ad-view */
            align-items: center;
            overflow: hidden;
            z-index: 2;
        }
        .marquee-text {
            /* MỚI: Chuyển thành flex để chứa logo */
            display: flex;
            align-items: center;
            gap: 1em; /* Tăng khoảng cách */
            font-size: 1.8rem; /* Tăng cỡ chữ nữa */
            font-weight: 600;
            color: white;
            white-space: nowrap;
            padding-left: 100%;
            animation: marquee 40s linear infinite; /* Tăng thời gian chạy cho phù hợp */
        }
        .marquee-text img {
            height: 60px; /* Tăng kích thước logo thêm 35% */
            width: auto;
            vertical-align: middle;
            margin: 0 0.2em;
            background: white; /* Thêm nền trắng cho logo SVG/PNG trong suốt */
            border-radius: 4px;
        }
        @keyframes marquee {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
        .corner-clock {
            position: absolute;
            bottom: 15px; /* Tăng khoảng cách */
            right: 20px; /* Tăng khoảng cách */
            background: black;
            color: white;
            padding: 8px 15px; /* Tăng padding */
            border-radius: var(--border-radius-md);
            font-family: monospace;
            font-size: 1.5rem; /* Tăng kích thước chữ */
            font-weight: 700;
            z-index: 3;
        }

        /* ================================================== */
        /* --- MỚI: GIAO DIỆN QUẢNG CÁO TOÀN MÀN HÌNH --- */
        /* ================================================== */
        #ad-view {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 200;
        }
        #ad-view .idle-video-background {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #ad-view #ad-video {
            width: 100%; height: 100%; object-fit: cover;
        }
        #ad-view .video-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); /* Lớp phủ tối nhẹ */
        }

        /* MỚI: Header cho màn hình quảng cáo */
        .ad-header {
            position: absolute;
            top: 25px;
            left: 25px;
            z-index: 3;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: var(--border-radius-lg);
            backdrop-filter: blur(5px);
        }
        .ad-header .logo {
            width: 45px; height: 45px;
        }
        .ad-header .org-name {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            line-height: 1.3;
        }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>
    <!-- 
        LƯU Ý: File này cần có config.js và locations.js trong cùng thư mục để hoạt động.
        Các file này được dùng để lấy API key thời tiết và thông tin các điểm trực.
    -->
    <!-- View 1: Chọn thanh toán -->
    <div id="payment-selection-view" class="confirmation-card hidden">
        <div class="aux-header">
            <div class="header-left">
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-Doan-Thanh-NIen-Cong-San-Ho-Chi-Minh-1.png" alt="Huy hiệu Đoàn" class="logo">
                <div class="org-name">Đoàn TNCS Hồ Chí Minh<br>Phường Ba Đình</div>
            </div>
            <div class="location-info">
                <span class="label">Bãi đỗ xe</span>
                <span class="value" id="header-location-name">--</span>
            </div>
        </div>
        <h1 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            THANH TOÁN PHÍ GỬI XE
        </h1>
        
        <!-- ================================================== -->
        <!-- --- BỐ CỤC NGANG MỚI --- -->
        <!-- ================================================== -->
        <div class="payment-content-grid">
            <!-- CỘT TRÁI: THÔNG TIN & LỰA CHỌN -->
            <div class="payment-details-panel">
                <div class="main-info-display">
                    <div class="plate-display" id="payment-plate">--</div>
                    <div class="time-in-display">
                        Giờ vào: <strong id="payment-time-in" style="color: var(--text-primary);">--</strong>
                    </div>
                </div>
                <div class="total-fee-container">
                    <div class="label"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>Tổng phí thanh toán</div>
                    <div class="amount">
                        <span id="payment-total-amount">0</span><sup>đ</sup>
                    </div>
                </div>
            </div>

            <!-- CỘT PHẢI: HIỂN THỊ QR HOẶC HƯỚNG DẪN -->
            <div id="right-panel-content" class="payment-qr-panel placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1em; opacity: 0.5;"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 12a10 10 0 0 0 10 10V12z"/></svg>
                Vui lòng chọn phương thức thanh toán
            </div>

            <!-- Các phần tử ẩn sẽ được di chuyển vào Cột Phải bằng JS -->
            <div id="qr-code-wrapper" class="qr-code-display hidden" style="transition: all 0.4s ease;">
                <img id="qr-code-image" src="" alt="Mã QR thanh toán">
                <p>Nội dung: <strong id="qr-memo">--</strong></p>
            </div>
        </div>
    </div>

    <!-- View 2: Thanh toán thành công -->
    <div id="success-view" class="confirmation-card hidden">
        <div class="success-icon-wrapper">
            <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="success-checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        <h1 class="card-title success" style="margin-bottom: 0;">THANH TOÁN THÀNH CÔNG</h1>
        
        <div class="success-main-content">
            <div class="success-amount-display">
                <div class="label">Tổng phí đã thanh toán</div>
                <div class="amount">
                    <span id="success-total-amount">0</span><sup>đ</sup>
                </div>
            </div>
            <div class="success-plate-display" id="success-plate">--</div>
            
            <!-- ================================================== -->
            <!-- --- KHU VỰC CHI TIẾT ĐÃ ĐƯỢC THIẾT KẾ LẠI --- -->
            <!-- ================================================== -->
            <div class="success-details-grid">
                <div class="detail-item">
                    <span class="label">Phương thức</span><span class="value" id="success-payment-method">--</span>
                </div>
                <div class="detail-item" style="text-align: right;">
                    <span class="label">Giờ vào</span><span class="value" id="success-time-in">--</span>
                </div>
                <div class="detail-item">
                    <span class="label">Giờ ra</span><span class="value" id="success-time-out">--</span>
                </div>
                <div class="success-duration-highlight detail-item">
                    <span class="label">Tổng thời gian</span><span class="value" id="success-duration">--</span>
                </div>
            </div>
        </div>
        <p class="thank-you-message">Cảm ơn quý khách & Hẹn gặp lại!</p>
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="window.close()">Đóng</button>
        </div>
        <p class="auto-close-note">Sẽ tự động chuyển sang màn hình chờ sau 10 giây.</p>
        <div id="confetti-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden;"></div>
    </div>

    <!-- MỚI: View 4 - Gửi xe thành công -->
    <div id="checkin-success-view" class="confirmation-card hidden">
        <div class="success-icon-wrapper">
            <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="success-checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        <h1 class="card-title success" style="margin-bottom: 0.5em;">ĐÃ GỬI XE THÀNH CÔNG</h1>
        <p class="thank-you-message" style="margin-top: 0; margin-bottom: 1.5em;">Vui lòng nhận vé và bảo quản cẩn thận.</p>

        <div class="success-main-content">
             <div class="success-plate-display" id="checkin-success-plate">--</div>
             <div class="success-details-grid" style="margin-top: 1.5em;">
                <div class="detail-item" style="grid-column: 1 / -1; text-align: center;">
                    <span class="label">Thời gian vào bãi</span>
                    <span class="value" id="checkin-success-time-in" style="font-size: 1.5rem;">--</span>
                </div>
             </div>
        </div>

        <p class="auto-close-note" style="margin-top: 2em;">Sẽ tự động chuyển sang màn hình chờ sau 10 giây.</p>
        <div id="checkin-confetti-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden;"></div>
    </div>

    <!-- MỚI: View 3 - Màn hình chờ -->
    <div id="idle-view" class="confirmation-card">
        <div class="idle-content">
            <div>
                <p class="idle-org-name">ĐOÀN TNCS HỒ CHÍ MINH - PHƯỜNG BA ĐÌNH</p>
                <p class="idle-location-name">Bãi đỗ xe: <strong id="idle-location-display">--</strong></p>
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-Doan-Thanh-NIen-Cong-San-Ho-Chi-Minh-1.png" alt="Huy hiệu Đoàn" class="idle-logo">
            </div>
            <h1 class="idle-title">Bãi đỗ xe Thanh niên<br>Kính chào Quý khách!</h1>
            <p class="idle-subtitle">Sẵn sàng cho lượt xe tiếp theo...</p>

            <!-- MỚI: Thêm widget đồng hồ và thời tiết -->
            <div class="idle-widgets">
                <div id="clock-widget" class="clock-widget" title="Thời gian thực">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span id="clock-display">--:--:--</span>
                </div>
                <div id="weather-widget" class="weather-widget" title="Thời tiết tại điểm trực"></div>
            </div>
        </div>
    </div>

    <!-- MỚI: View 5 - Màn hình quảng cáo -->
    <div id="ad-view" class="hidden">
        <!-- MỚI: Header cho màn hình quảng cáo -->
        <div class="ad-header">
            <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-Doan-Thanh-NIen-Cong-San-Ho-Chi-Minh-1.png" alt="Huy hiệu Đoàn" class="logo">
            <div class="org-name">
                ĐOÀN TNCS HỒ CHÍ MINH<br>PHƯỜNG BA ĐÌNH
            </div>
        </div>

        <div class="idle-video-background">
            <video id="ad-video" muted playsinline loop></video>
            <div class="video-overlay"></div>
        </div>
        <div class="idle-footer-bar">
            <!-- MỚI: Dòng chữ chạy với nội dung và logo đầy đủ -->
            <div class="marquee-text">
                <span>Chương trình Bãi đỗ xe Thanh niên do Đoàn TNCS Hồ Chí Minh Phường Ba Đình</span>
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-Doan-Thanh-NIen-Cong-San-Ho-Chi-Minh-1.png" alt="Logo Đoàn Thanh Niên">
                <span>tổ chức, với sự đồng hành của các nhà tài trợ: Vietcombank Ba Đình</span>
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/02/Logo-Vietcombank.png" alt="Logo Vietcombank">
                <span>và Vinamilk</span>
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/eb/Logo_Vinamilk_%282023%29.png" alt="Logo Vinamilk">
                <span>. Kính chúc Quý khách một ngày tốt lành!</span>
            </div>
        </div>
        <div id="corner-clock-display" class="corner-clock">--:--:--</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const paymentView = document.getElementById('payment-selection-view');
            const successView = document.getElementById('success-view');
            const checkinSuccessView = document.getElementById('checkin-success-view'); // MỚI
            const qrWrapper = document.getElementById('qr-code-wrapper');
            const rightPanel = document.getElementById('right-panel-content');
            const idleView = document.getElementById('idle-view'); // MỚI
            const adView = document.getElementById('ad-view'); // MỚI
            const adVideo = document.getElementById('ad-video'); // MỚI

            const paymentChannel = new BroadcastChannel('parking_payment_channel');

            // MỚI: Biến lưu trữ tọa độ
            let currentLocationCoords = { lat: null, lng: null };
            let inactivityTimer = null;

            // --- MỚI: HÀM HIỆU ỨNG CONFETTI ---
            function startConfetti(containerId = 'confetti-container') {
                const container = document.getElementById(containerId);
                if (!container) return;
                const confettiCount = 150;
                const colors = ['#0056b3', '#007bff', '#ffc107', '#28a745', '#dc3545'];

                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.style.position = 'absolute';
                    confetti.style.width = `${Math.random() * 10 + 5}px`;
                    confetti.style.height = `${Math.random() * 6 + 4}px`;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.opacity = '1';
                    
                    // Vị trí ban đầu ở trung tâm
                    const startX = 50;
                    const startY = 50;
                    confetti.style.left = `${startX}%`;
                    confetti.style.top = `${startY}%`;

                    // Tính toán quỹ đạo bay ra ngoài
                    const angle = Math.random() * 360;
                    const radius = Math.random() * 300 + 150;
                    const endX = startX + radius * Math.cos(angle * Math.PI / 180);
                    const endY = startY + radius * Math.sin(angle * Math.PI / 180);
                    
                    confetti.style.transition = `transform 1.5s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 1.5s ease-out`;
                    container.appendChild(confetti);

                    setTimeout(() => { confetti.style.transform = `translate(${endX - startX}vw, ${endY - startY}vh) rotate(${Math.random() * 720}deg)`; confetti.style.opacity = '0'; }, 10);
                    setTimeout(() => confetti.remove(), 1600);
                }
            }

            // =================================================================
            // --- MỚI: HÀM ĐỒNG HỒ & THỜI TIẾT (Tái sử dụng từ index.html) ---
            // =================================================================
            const updateClock = () => {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const timeString = `${hours}:${minutes}:${seconds}`;
                
                const clockDisplay = document.getElementById('clock-display');
                if (clockDisplay) clockDisplay.textContent = timeString;

                // MỚI: Cập nhật đồng hồ ở góc
                const cornerClockDisplay = document.getElementById('corner-clock-display');
                if (cornerClockDisplay) cornerClockDisplay.textContent = timeString;
            };

            const fetchWeather = async (lat, lon) => {
                const weatherWidget = document.getElementById('weather-widget');
                if (!weatherWidget) return;

                const apiKey = APP_CONFIG.weather.apiKey;
                if (!apiKey || apiKey === "YOUR_OPENWEATHERMAP_API_KEY" || !lat || !lon) {
                    weatherWidget.innerHTML = `<span>Thời tiết không khả dụng</span>`;
                    return;
                }
                try {
                    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=vi`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Lỗi HTTP: ${response.status}`);
                    const data = await response.json();
                    weatherWidget.innerHTML = `<img id="weather-icon" src="https://openweathermap.org/img/wn/${data.weather[0].icon}.png" alt="Thời tiết" style="display: inline;"><span id="weather-temp">${Math.round(data.main.temp)}°C</span><span id="weather-desc">${data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1)}</span>`;
                } catch (error) {
                    console.error("Lỗi tải thời tiết:", error);
                    weatherWidget.innerHTML = `<span>Lỗi thời tiết</span>`;
                }
            };

            // =================================================================
            // --- MỚI: HÀM XỬ LÝ VIDEO QUẢNG CÁO ---
            // =================================================================
            let currentVideoIndex = 0;
            const adPlaylist = APP_CONFIG.adVideos || [];
            
            const startInactivityTimer = () => {
                clearTimeout(inactivityTimer); // Xóa timer cũ
                inactivityTimer = setTimeout(() => {
                    // Chuyển sang chế độ quảng cáo nếu không có giao dịch nào đang diễn ra
                    idleView.classList.add('hidden');
                    adView.classList.remove('hidden');
                    playNextVideo();
                }, 10000); // 10 giây
            };

            const stopInactivityTimerAndAds = () => {
                clearTimeout(inactivityTimer);
                adView.classList.add('hidden');
                if (adVideo && !adVideo.paused) adVideo.pause();
            };

            const playNextVideo = () => {
                if (adPlaylist.length === 0 || !adVideo) return;
                adVideo.src = adPlaylist[currentVideoIndex];
                adVideo.play().catch(e => console.error("Lỗi phát video:", e));
                currentVideoIndex = (currentVideoIndex + 1) % adPlaylist.length;
            };

            if (adVideo) {
                adVideo.onended = playNextVideo; // Tự động phát video tiếp theo khi hết
            }
            // SỬA LỖI: Chủ động yêu cầu dữ liệu từ trang chính
            const urlParams = new URLSearchParams(window.location.search);
            
            // MỚI: Khởi tạo màn hình chờ ngay lập tức
            const initialLat = urlParams.get('lat');
            const initialLng = urlParams.get('lng');
            const initialLocationName = urlParams.get('locationName');

            if (initialLocationName) {
                const decodedLocationName = decodeURIComponent(initialLocationName);
                document.getElementById('header-location-name').textContent = decodedLocationName;
                document.getElementById('idle-location-display').textContent = decodedLocationName; // MỚI
            }
            currentLocationCoords.lat = initialLat;
            currentLocationCoords.lng = initialLng;
            updateClock();
            setInterval(updateClock, 1000);
            fetchWeather(initialLat, initialLng);
            startInactivityTimer(); // Bắt đầu đếm giờ để hiện quảng cáo
            idleView.classList.remove('hidden'); // Hiển thị màn hình chờ mặc định

            // =================================================================
            // GIẢI PHÁP MỚI: Lắng nghe sự kiện và nhận dữ liệu trực tiếp
            // =================================================================
            paymentChannel.onmessage = (event) => {
                const { type, payload, method } = event.data;
                
                stopInactivityTimerAndAds(); // Dừng quảng cáo và timer khi có bất kỳ giao dịch nào

                if (type === 'VEHICLE_CHECKOUT_INITIATE') {
                    checkinSuccessView.classList.add('hidden'); // Đảm bảo các view khác bị ẩn
                    successView.classList.add('hidden');
                    idleView.classList.add('hidden'); // Ẩn màn hình chờ
                    paymentView.classList.remove('hidden'); // Hiện màn hình thanh toán
                    document.getElementById('payment-total-amount').textContent = payload.totalAmount.replace(/đ/g, '');
                    document.getElementById('qr-code-image').src = payload.qrImageUrl;
                    document.getElementById('qr-memo').textContent = payload.paymentMemo;
                    document.getElementById('payment-plate').textContent = payload.licensePlate;
                    document.getElementById('payment-time-in').textContent = payload.timeIn;
                    document.getElementById('header-location-name').textContent = payload.locationName || 'Không xác định';

                    // NÂNG CẤP: Reset về trạng thái ban đầu (1 cột, căn giữa)
                    const grid = document.querySelector('.payment-content-grid');
                    grid.classList.remove('method-selected');
                    
                    // MỚI: Lưu lại tọa độ
                    currentLocationCoords.lat = payload.lat;
                    currentLocationCoords.lng = payload.lng;

                } else if (type === 'PAYMENT_METHOD_SELECTED') {
                    if (method === 'qr') {
                        // NÂNG CẤP: Kích hoạt hiệu ứng chuyển sang 2 cột
                        const grid = document.querySelector('.payment-content-grid');
                        grid.classList.add('method-selected');

                        // Di chuyển nội dung QR vào panel phải
                        rightPanel.innerHTML = '';
                        rightPanel.classList.remove('placeholder');
                        qrWrapper.classList.remove('hidden'); // Hiển thị lại
                        rightPanel.appendChild(qrWrapper);
                    } else if (method === 'cash') {
                        // Di chuyển nút tiền mặt vào panel phải
                        // NÂNG CẤP: Kích hoạt hiệu ứng chuyển sang 2 cột
                        const grid = document.querySelector('.payment-content-grid');
                        grid.classList.add('method-selected');

                        rightPanel.innerHTML = '';
                        rightPanel.classList.remove('placeholder');
                        // Hiển thị hướng dẫn thanh toán tiền mặt
                        rightPanel.innerHTML = `
                            <div style="text-align: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--primary-accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1em;"><path d="M12 12V12"/><path d="M10.62 6.38a4 4 0 1 0 5.25 5.25"/><path d="M12 19.52A7.52 7.52 0 1 0 4.48 12"/><path d="M12 12V12"/></svg>
                                <h3 style="font-size: 1.5rem; color: var(--text-primary); margin-bottom: 0.5em;">Thanh toán bằng tiền mặt</h3>
                                <p style="font-size: 1.1rem; color: var(--text-secondary);">Vui lòng đưa tiền cho nhân viên tại quầy.</p>
                            </div>
                        `;
                    }
                } else if (type === 'CHECKOUT_COMPLETE') {
                    idleView.classList.add('hidden');
                    checkinSuccessView.classList.add('hidden');
                    paymentView.classList.add('hidden');
                    successView.classList.remove('hidden');
                    startConfetti(); // Kích hoạt hiệu ứng
                    document.getElementById('success-plate').textContent = payload.licensePlate;
                    document.getElementById('success-time-in').textContent = payload.timeIn;
                    document.getElementById('success-time-out').textContent = payload.timeOut;
                    document.getElementById('success-duration').textContent = payload.duration;
                    document.getElementById('success-payment-method').textContent = payload.paymentMethod;
                    document.getElementById('success-total-amount').textContent = payload.totalAmount.replace(/đ/g, '');

                    // THAY ĐỔI: Chuyển sang màn hình chờ thay vì đóng
                    setTimeout(() => {
                        successView.style.animation = 'fadeOut 0.5s ease forwards';
                        
                        // Quay về màn hình chờ
                        setTimeout(() => {
                            successView.classList.add('hidden');
                            successView.style.animation = ''; // Reset animation
                            idleView.classList.remove('hidden');
                            idleView.style.animation = 'fadeIn 0.5s ease';
                            startInactivityTimer(); // Bắt đầu lại timer chờ quảng cáo
                        }, 500);
                    }, 10000); // Chuyển sang màn hình chờ sau 10 giây
                } else if (type === 'VEHICLE_CHECKIN_COMPLETE') { // MỚI: Xử lý khi gửi xe thành công
                    idleView.classList.add('hidden');
                    paymentView.classList.add('hidden');
                    successView.classList.add('hidden');
                    checkinSuccessView.classList.remove('hidden');
                    startConfetti('checkin-confetti-container');

                    document.getElementById('checkin-success-plate').textContent = payload.licensePlate;
                    document.getElementById('checkin-success-time-in').textContent = payload.timeIn;

                    // Tự động quay về màn hình chờ
                    setTimeout(() => {
                        checkinSuccessView.style.animation = 'fadeOut 0.5s ease forwards';
                        
                        setTimeout(() => {
                            checkinSuccessView.classList.add('hidden');
                            checkinSuccessView.style.animation = ''; // Reset animation
                            idleView.classList.remove('hidden');
                            idleView.style.animation = 'fadeIn 0.5s ease';
                            startInactivityTimer();
                        }, 500);
                    }, 10000);
                } else if (type === 'TRANSACTION_CANCELED') { // MỚI: Xử lý khi giao dịch bị hủy
                    // Ẩn các view khác và quay về màn hình chờ
                    paymentView.classList.add('hidden');
                    successView.classList.add('hidden');
                    checkinSuccessView.classList.add('hidden');
                    idleView.classList.remove('hidden');
                    idleView.style.animation = 'fadeIn 0.5s ease';
                    startInactivityTimer();
                }
            };

        });
    </script>
</body>
</html>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const paymentView = document.getElementById('payment-selection-view');
            const successView = document.getElementById('success-view');
            const checkinSuccessView = document.getElementById('checkin-success-view'); // MỚI
            const selectQrBtn = document.getElementById('select-qr-btn');
            const selectCashBtn = document.getElementById('select-cash-btn');
            const qrWrapper = document.getElementById('qr-code-wrapper');
            const cashPaymentAction = document.getElementById('cash-payment-action');
            const completeCashPaymentBtn = document.getElementById('complete-cash-payment-btn');
            const rightPanel = document.getElementById('right-panel-content');
            const idleView = document.getElementById('idle-view'); // MỚI
            const adVideo = document.getElementById('ad-video'); // MỚI

            const paymentChannel = new BroadcastChannel('parking_payment_channel');
            
            // MỚI: Biến lưu trữ tọa độ
            let currentLocationCoords = { lat: null, lng: null };

            // --- MỚI: HÀM HIỆU ỨNG CONFETTI ---
            function startConfetti(containerId = 'confetti-container') {
                const container = document.getElementById(containerId);
                if (!container) return;
                const confettiCount = 150;
                const colors = ['#0056b3', '#007bff', '#ffc107', '#28a745', '#dc3545'];

                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.style.position = 'absolute';
                    confetti.style.width = `${Math.random() * 10 + 5}px`;
                    confetti.style.height = `${Math.random() * 6 + 4}px`;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.opacity = '1';
                    
                    // Vị trí ban đầu ở trung tâm
                    const startX = 50;
                    const startY = 50;
                    confetti.style.left = `${startX}%`;
                    confetti.style.top = `${startY}%`;

                    // Tính toán quỹ đạo bay ra ngoài
                    const angle = Math.random() * 360;
                    const radius = Math.random() * 300 + 150;
                    const endX = startX + radius * Math.cos(angle * Math.PI / 180);
                    const endY = startY + radius * Math.sin(angle * Math.PI / 180);
                    
                    confetti.style.transition = `transform 1.5s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 1.5s ease-out`;
                    container.appendChild(confetti);

                    setTimeout(() => { confetti.style.transform = `translate(${endX - startX}vw, ${endY - startY}vh) rotate(${Math.random() * 720}deg)`; confetti.style.opacity = '0'; }, 10);
                    setTimeout(() => confetti.remove(), 1600);
                }
            }

            // =================================================================
            // --- MỚI: HÀM ĐỒNG HỒ & THỜI TIẾT (Tái sử dụng từ index.html) ---
            // =================================================================
            const updateClock = () => {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const clockDisplay = document.getElementById('clock-display');
                if (clockDisplay) {
                    clockDisplay.textContent = `${hours}:${minutes}:${seconds}`;
                }
            };

            const fetchWeather = async (lat, lon) => {
                const weatherWidget = document.getElementById('weather-widget');
                if (!weatherWidget) return;

                const apiKey = APP_CONFIG.weather.apiKey;
                if (!apiKey || apiKey === "YOUR_OPENWEATHERMAP_API_KEY" || !lat || !lon) {
                    weatherWidget.innerHTML = `<span>Thời tiết không khả dụng</span>`;
                    return;
                }
                try {
                    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=vi`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Lỗi HTTP: ${response.status}`);
                    const data = await response.json();
                    weatherWidget.innerHTML = `<img id="weather-icon" src="https://openweathermap.org/img/wn/${data.weather[0].icon}.png" alt="Thời tiết" style="display: inline;"><span id="weather-temp">${Math.round(data.main.temp)}°C</span><span id="weather-desc">${data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1)}</span>`;
                } catch (error) {
                    console.error("Lỗi tải thời tiết:", error);
                    weatherWidget.innerHTML = `<span>Lỗi thời tiết</span>`;
                }
            };

            // =================================================================
            // --- MỚI: HÀM XỬ LÝ VIDEO QUẢNG CÁO ---
            // =================================================================
            let currentVideoIndex = 0;
            const adPlaylist = APP_CONFIG.adVideos || [];

            const playNextVideo = () => {
                if (adPlaylist.length === 0 || !adVideo) return;
                adVideo.src = adPlaylist[currentVideoIndex];
                adVideo.play().catch(e => console.error("Lỗi phát video:", e));
                currentVideoIndex = (currentVideoIndex + 1) % adPlaylist.length;
            };

            if (adVideo) {
                adVideo.onended = playNextVideo; // Tự động phát video tiếp theo khi hết
            }
            // =================================================================


            // SỬA LỖI: Chủ động yêu cầu dữ liệu từ trang chính
            const urlParams = new URLSearchParams(window.location.search);
            
            // MỚI: Khởi tạo màn hình chờ ngay lập tức
            const initialLat = urlParams.get('lat');
            const initialLng = urlParams.get('lng');
            const initialLocationName = urlParams.get('locationName');

            if (initialLocationName) {
                const decodedLocationName = decodeURIComponent(initialLocationName);
                document.getElementById('header-location-name').textContent = decodedLocationName;
                document.getElementById('idle-location-display').textContent = decodedLocationName; // MỚI
            }
            currentLocationCoords.lat = initialLat;
            currentLocationCoords.lng = initialLng;
            updateClock();
            setInterval(updateClock, 1000);
            fetchWeather(initialLat, initialLng);
            playNextVideo(); // Bắt đầu phát video quảng cáo

            // =================================================================
            // GIẢI PHÁP MỚI: Lắng nghe sự kiện và nhận dữ liệu trực tiếp
            // =================================================================
            paymentChannel.onmessage = (event) => {
                const { type, payload, method } = event.data;
                if (adVideo) adVideo.pause(); // Tạm dừng video khi có giao dịch

                if (type === 'VEHICLE_CHECKOUT_INITIATE') {
                    checkinSuccessView.classList.add('hidden'); // Đảm bảo các view khác bị ẩn
                    successView.classList.add('hidden');
                    idleView.classList.add('hidden'); // Ẩn màn hình chờ
                    paymentView.classList.remove('hidden'); // Hiện màn hình thanh toán
                    document.getElementById('payment-total-amount').textContent = payload.totalAmount.replace(/đ/g, '');
                    document.getElementById('qr-code-image').src = payload.qrImageUrl;
                    document.getElementById('qr-memo').textContent = payload.paymentMemo;
                    document.getElementById('payment-plate').textContent = payload.licensePlate;
                    document.getElementById('payment-time-in').textContent = payload.timeIn;
                    document.getElementById('header-location-name').textContent = payload.locationName || 'Không xác định';
                    
                    // MỚI: Lưu lại tọa độ
                    currentLocationCoords.lat = payload.lat;
                    currentLocationCoords.lng = payload.lng;

                } else if (type === 'PAYMENT_METHOD_SELECTED') {
                    if (method === 'qr') {
                        selectQrBtn.classList.add('active');
                        selectCashBtn.classList.remove('active');
                        // Di chuyển nội dung QR vào panel phải
                        rightPanel.innerHTML = '';
                        rightPanel.classList.remove('placeholder');
                        qrWrapper.classList.remove('hidden'); // Hiển thị lại
                        rightPanel.appendChild(qrWrapper);
                    } else if (method === 'cash') {
                        selectCashBtn.classList.add('active');
                        selectQrBtn.classList.remove('active');
                        // Di chuyển nút tiền mặt vào panel phải
                        rightPanel.innerHTML = '';
                        rightPanel.classList.remove('placeholder');
                        cashPaymentAction.classList.remove('hidden'); // Hiển thị lại
                        rightPanel.appendChild(cashPaymentAction);
                        // Thêm hướng dẫn cho nhân viên
                        rightPanel.insertAdjacentHTML('afterbegin', '<p style="margin-bottom: 1.5em; color: var(--text-secondary);">Vui lòng thu tiền mặt từ khách và nhấn "Hoàn tất".</p>');
                    }
                } else if (type === 'CHECKOUT_COMPLETE') {
                    idleView.classList.add('hidden');
                    checkinSuccessView.classList.add('hidden');
                    paymentView.classList.add('hidden');
                    successView.classList.remove('hidden');
                    startConfetti(); // Kích hoạt hiệu ứng
                    document.getElementById('success-plate').textContent = payload.licensePlate;
                    document.getElementById('success-time-in').textContent = payload.timeIn;
                    document.getElementById('success-time-out').textContent = payload.timeOut;
                    document.getElementById('success-duration').textContent = payload.duration;
                    document.getElementById('success-payment-method').textContent = payload.paymentMethod;
                    document.getElementById('success-total-amount').textContent = payload.totalAmount.replace(/đ/g, '');

                    // THAY ĐỔI: Chuyển sang màn hình chờ thay vì đóng
                    setTimeout(() => {
                        successView.style.animation = 'fadeOut 0.5s ease forwards';
                        
                        // Quay về màn hình chờ
                        setTimeout(() => {
                            successView.classList.add('hidden');
                            successView.style.animation = ''; // Reset animation
                            idleView.classList.remove('hidden');
                            idleView.style.animation = 'fadeIn 0.5s ease';
                            if (adVideo) adVideo.play().catch(e => {}); // Tiếp tục phát video
                        }, 500); // Đợi hiệu ứng fadeOut hoàn tất
                    }, 10000); // Chuyển sang màn hình chờ sau 10 giây
                } else if (type === 'VEHICLE_CHECKIN_COMPLETE') { // MỚI: Xử lý khi gửi xe thành công
                    idleView.classList.add('hidden');
                    paymentView.classList.add('hidden');
                    successView.classList.add('hidden');
                    checkinSuccessView.classList.remove('hidden');
                    startConfetti('checkin-confetti-container');

                    document.getElementById('checkin-success-plate').textContent = payload.licensePlate;
                    document.getElementById('checkin-success-time-in').textContent = payload.timeIn;

                    // Tự động quay về màn hình chờ
                    setTimeout(() => {
                        checkinSuccessView.style.animation = 'fadeOut 0.5s ease forwards';
                        
                        setTimeout(() => {
                            checkinSuccessView.classList.add('hidden');
                            checkinSuccessView.style.animation = ''; // Reset animation
                            idleView.classList.remove('hidden');
                            idleView.style.animation = 'fadeIn 0.5s ease';
                            if (adVideo) adVideo.play().catch(e => {}); // Tiếp tục phát video
                        }, 500);
                    }, 10000);
                } else if (type === 'TRANSACTION_CANCELED') { // MỚI: Xử lý khi giao dịch bị hủy
                    // Ẩn các view khác và quay về màn hình chờ
                    paymentView.classList.add('hidden');
                    successView.classList.add('hidden');
                    checkinSuccessView.classList.add('hidden');
                    idleView.classList.remove('hidden');
                    idleView.style.animation = 'fadeIn 0.5s ease';
                    if (adVideo) adVideo.play().catch(e => {}); // Tiếp tục phát video
                }
            };

        });
    </script>
</body>
</html>
