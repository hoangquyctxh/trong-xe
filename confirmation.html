<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác nhận xe ra</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script> <!-- MỚI: Tải file cấu hình -->
    <style>
        :root {
            /* --- BẢNG MÀU "2015": Cổ điển, vuông vức, rõ ràng --- */
            --bg-main: #eeeeee;
            --bg-card: #ffffff;
            --border-color: #cccccc;
            --primary-accent: #337ab7;
            --primary-accent-light: #286090;
            --text-primary: #333333;
            --text-secondary: #777777;
            --danger-color: #d9534f;
            --success-color: #5cb85c;
            --transition-fast: all 0.2s ease-in-out;
            --shadow-sm: none;
            --shadow-md: none;
            --shadow-lg: none;
            --border-radius-lg: 4px;
            --border-radius-md: 0.375rem;
        }
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 2em;
            display: flex;
            align-items: center; 
            justify-content: center;
            height: 100vh;
            box-sizing: border-box;
        }
        /* --- GIAO DIỆN CHUNG --- */
        .confirmation-card {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg); border: 1px solid #999;
            width: 100%;
            max-width: 900px; /* Tăng độ rộng tối đa cho bố cục ngang */
            padding: 2.5em;
            border: 1px solid var(--border-color);
            position: relative;
        }
        #success-view .confirmation-card::after {
            background: var(--success-color);
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: scale(0.95); }
            to   { opacity: 1; transform: scale(1); }
        }
        .card-title {
            color: var(--primary-accent);
            font-size: 1.8rem;
            margin-bottom: 0.5em;
            display: flex;
            align-items: center; 
            justify-content: center;
            gap: 15px;
            font-weight: 700;
        }
        .card-title.success {
            color: var(--success-color);
        }
 
        /* --- HIỆU ỨNG CHO ICON THÀNH CÔNG --- */
        .success-icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 1em auto;
        }
        .success-checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 3;
            stroke: white;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px var(--success-color);
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .success-checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 3;
            stroke-miterlimit: 10;
            stroke: var(--success-color);
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .success-checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        } 
        @keyframes stroke {
            100% { stroke-dashoffset: 0; } } @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } } @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 40px var(--success-color); }
        }
        .info-grid {
            margin-top: 2em;
            display: flex;
            flex-direction: column;
            gap: 1em;
            text-align: left;
            font-size: 1.1rem;
            border-top: 1px dashed var(--border-color);
            padding-top: 2em;
        }
        .info-item {
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }
        .info-item .label {
            color: var(--text-secondary);
        }
        .info-item .value {
            font-weight: 700;
        }
        .total-amount-value {
            color: var(--danger-color);
            font-size: 1.2em;
        }
        .hidden { display: none !important; }
        .total-fee-container .label {
            display: flex;
            align-items: center; justify-content: center; gap: 10px;
            font-size: 1.1rem; 
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* --- GIAO DIỆN CHỌN THANH TOÁN --- */
        .total-fee-container {
            background: #f2dede;
            border: 1px solid #ebccd1;
            border-radius: var(--border-radius-md);
            padding: 1.5em 2em;
            margin-bottom: 2em;
        }
        .total-fee-container .amount {
            font-size: 3.5rem;
            font-weight: 700;
            color: #a94442;
            line-height: 1;
            margin-top: 0.2em;
        }
        .total-fee-container .amount sup {
            font-size: 2rem;
            font-weight: 700;
            vertical-align: top;
        }
        .payment-content-grid {
            display: grid;
            grid-template-columns: 1fr; /* Mặc định 1 cột cho mobile */
            gap: 2em;
            margin-top: 1.5em;
        }
        /* Bố cục 2 cột cho màn hình lớn hơn */
        @media (min-width: 768px) {
            .payment-content-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .payment-details-panel {
            display: flex;
            flex-direction: column; 
            width: 100%;
        }
        .payment-right-panel {
            background-color: var(--bg-main);
            border-radius: var(--border-radius-md);
            padding: 2em;
            border: 1px solid var(--border-color); 
            min-height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }
        .payment-right-panel.placeholder {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Tách riêng nút chọn và làm nổi bật */
        .payment-method-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1em;
            margin-bottom: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1.5em; 
        }
        .method-btn {
            padding: 12px; border-radius: var(--border-radius-md); 
            border: 1px solid var(--border-color);
            background: #f5f5f5; color: var(--text-primary); 
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 1rem;
        } 
        .method-btn.active { 
            background: var(--primary-accent); color: white; border-color: var(--primary-accent); 
        }
        .qr-code-display {
            padding: 15px;
            background: #fff;
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius-md);
            max-width: 280px;
            margin: 0 auto;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 1;
            transform: translateY(0);
        }
        .qr-code-display img { 
            width: 100%;
            height: auto;
            display: block;
        }
        .qr-code-display p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
            word-break: break-all;
        }
        .qr-code-display strong {
            font-family: monospace;
            color: var(--text-primary);
        }
        .qr-code-display.hidden {
            opacity: 0;
            transform: translateY(10px);
            height: 0;
            padding: 0; margin: 0; overflow: hidden;
        }
        /* MỚI: Bố cục hiển thị thông tin chính */
        .main-info-display {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 1.5em;
            margin-bottom: 1.5em;
        } 
        .main-info-display .plate-display {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-accent);
            font-family: monospace, sans-serif;
            line-height: 1.1;
        }
        .main-info-display .time-in-display {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-top: 0.5em;
        }
        /* --- NÚT HÀNH ĐỘNG --- */
        .action-buttons {
            margin-top: 2em;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5em;
        } 
        .btn { 
        .receipt-footer { /* Thiết kế lại khu vực chân biên lai */
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px dashed var(--border-color);
            display: flex;
            justify-content: center;
        } 
        .btn-cancel {
            background: none; border: none; color: var(--primary-accent);
            font-weight: 600; cursor: pointer; text-decoration: underline;
            font-size: 1rem; transition: color 0.2s;
        }
        .btn-cancel:hover { color: var(--danger-color); }
            display: inline-block;
            width: 100%;
            padding: 0.8em 1em;
            font-size: 1.1rem;
            font-weight: 700; border: 1px solid transparent;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
        }
        .btn-primary {
            background-color: var(--primary-accent);
            border-color: var(--primary-accent-light);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-accent-light); 
            box-shadow: var(--shadow-md);
        }
        .auto-close-note {
            margin-top: 1.5em; font-size: 0.9rem; color: var(--text-secondary);
        }
        
        /* --- MỚI: Header phụ cho trang --- */
        .aux-header {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            gap: 18px;
            margin-bottom: 2em;
            padding-bottom: 1.5em;
            border-bottom: 1px dashed var(--border-color);
        } 
        .aux-header .logo { 
            width: 50px;
            height: 50px;
        }
        .aux-header .org-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            line-height: 1.4;
            text-align: left;
        }
        /* Nhóm các phần tử bên trái */
        .header-left {
            display: flex;
            align-items: center; 
            gap: 18px; 
        }
        /* MỚI: Phần thông tin điểm trực bên phải */
        .location-info {
            text-align: right;
        }
        .location-info .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: block;
        }
        .location-info .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-accent);
        }

        /* ================================================== */
        /* --- REDESIGN: GIAO DIỆN THÀNH CÔNG - TOP 1 --- */
        /* ================================================== */
        #success-view .card-title { animation: fadeInDown 0.5s 1s backwards; }
        
        .success-main-content { 
            animation: fadeIn 0.5s 1.2s backwards;
        }
        
        .success-amount-display {
            margin: 0.5em 0; 
        }
        .success-amount-display .label {
            font-size: 1.2rem;
            color: var(--text-secondary);
            animation: fadeInUp 0.5s 1.4s backwards;
        } 
        .success-amount-display .amount {
            font-size: 3.8rem;
            font-weight: 700;
            color: var(--success-color);
            line-height: 1.1;
            animation: popInAmount 0.6s 1.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) backwards;
        }
        .success-amount-display .amount sup {
            font-size: 2rem;
            font-weight: 600;
        }
        
        .success-plate-display {
            font-size: 2.5rem;
            font-weight: 600;
            font-family: monospace;
            color: var(--text-primary);
            background: var(--bg-main);
            padding: 10px 25px; 
            border-radius: var(--border-radius-md);
            display: inline-block;
            border: 1px solid var(--border-color);
            margin-top: 0.5em;
            animation: fadeInUp 0.5s 1.8s backwards;
        }

        /* ================================================== */
        /* --- MỚI: TÁI CẤU TRÚC CHI TIẾT THANH TOÁN --- */
        /* ================================================== */
        .success-details-grid {
            display: grid;
            grid-template-columns: 1fr; /* Mặc định 1 cột */
            gap: 0.8em 2.5em;
            margin-top: 1.5em; 
            padding: 1.2em 1.8em;
            background: #f9f9f9;
            border-radius: 0;
            border: 1px solid var(--border-color);
            text-align: left;
            animation: fadeInUp 0.5s 2s backwards;
        }
        .success-details-grid .detail-item { 
            font-size: 1.1rem;
        } 
        .success-details-grid .detail-item .label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .success-details-grid .detail-item .label svg {
            width: 16px; height: 16px;
        }
        .success-details-grid .detail-item .value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 700;
            padding-left: 24px; /* Căn lề với label */
        }
        /* Bố cục 2 cột cho màn hình lớn hơn */
        @media (min-width: 500px) {
            .success-details-grid { grid-template-columns: 1fr 1fr; }
        }
        .success-duration-highlight {
            grid-column: 1 / -1;
            margin-top: 0.8em; 
            padding-top: 0.8em;
            border-top: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .success-duration-highlight .label { font-size: 1rem; }
        .success-duration-highlight .value {
            font-weight: 700;
            color: var(--primary-accent);
        }

        .thank-you-message {
            margin-top: 1em;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
            animation: fadeInUp 0.5s 2.2s backwards;
        }

        /* ================================================== */
        /* --- MỚI: GIAO DIỆN MÀN HÌNH CHỜ (IDLE) --- */
        /* ================================================== */
        #idle-view .confirmation-card::after {
            background: var(--primary-accent); /* Giữ lại để phân biệt */
        } 
        .idle-content-horizontal {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .idle-header {
            width: 100%;
            text-align: center;
            margin-bottom: 2em;
        }
        .idle-header .idle-org-name { font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 1.5em; }
        /* CSS cho tên điểm trực ở màn hình chờ */
        .idle-location-name {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: -1em;
            margin-bottom: 1.5em;
        }
        .idle-location-name strong {
            color: var(--primary-accent);
        }
        .idle-header .idle-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 1em;
        }

        /* NÂNG CẤP: Bố cục 2 cột cho phần chính */
        .idle-main {
            display: grid; 
            grid-template-columns: 1fr 1fr;
            gap: 2.5em;
            width: 100%;
            align-items: start;
        }
        .idle-left-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .idle-right-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* NÂNG CẤP: CSS cho bàn phím ảo T9 */
        .virtual-keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 380px;
        }
        .kb-btn { 
            aspect-ratio: 1 / 0.8; /* Giữ tỷ lệ nút */
            border: 1px solid var(--border-color);
            background-color: #f5f5f5;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        .kb-btn:hover { 
            background-color: #e9e9e9;
            box-shadow: var(--shadow-md);
            border-color: #adadad;
        }
        .kb-btn:active { 
            transform: translateY(1px);
            background-color: var(--bg-main);
        }
        .kb-btn .num {
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
        }
        .kb-btn .chars {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .kb-btn.special {
            background-color: var(--bg-main);
        }
        .kb-btn.special .num {
            font-size: 1.5rem;
        }
        .kb-btn.danger {
            background-color: #f2dede;
            border-color: #ebccd1;
        }
        .kb-btn.danger .num {
            color: var(--danger-color);
        }

        /* Điều chỉnh lại khu vực kiosk cho phù hợp */
        .self-service-kiosk {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
            width: 100%;
            max-width: none;
            animation: none;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #kiosk-plate-input {
            flex-grow: 1; /* Cho phép input co giãn */
            margin-bottom: 1em;
        }
        /* CSS cho widget thời tiết & đồng hồ */
        .idle-widgets {
            display: flex;
            gap: 20px;
            margin-top: 2.5em; 
        }
        .clock-widget, .weather-widget { /* Làm to rõ hơn */
            display: flex; align-items: center; gap: 8px;
            background: var(--bg-main);
            padding: 12px 18px;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        .clock-widget .icon, #weather-icon { color: var(--primary-accent); width: 28px; height: 28px; }
        #clock-display { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        #weather-temp { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        #weather-icon { height: 28px; width: auto; }

        /* ================================================== */
        /* --- MỚI: DÒNG CHỮ CHẠY & ĐỒNG HỒ GÓC PHẢI --- */
        /* ================================================== */
        .idle-footer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0; 
            height: 80px;
            background: rgba(0, 0, 0, 0.4); 
            display: flex; 
            align-items: center;
            overflow: hidden;
            z-index: 2;
        }
        .marquee-text {
            display: flex;
            align-items: center;
            gap: 1em;
            font-size: 1.8rem;
            font-weight: 600;
            color: white; 
            white-space: nowrap;
            padding-left: 100%;
            animation: marquee 40s linear infinite;
        }
        .marquee-text img {
            height: 60px;
            width: auto;
            vertical-align: middle;
            margin: 0 0.2em;
            background: white; /* Thêm nền trắng cho logo SVG/PNG trong suốt */
            border-radius: 4px;
        }
        @keyframes marquee {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
        .corner-clock {
            position: absolute;
            bottom: 15px;
            right: 20px;
            background: black;
            color: white;
            padding: 8px 15px; 
            border-radius: var(--border-radius-md);
            font-family: monospace; 
            font-size: 1.5rem; /* Tăng kích thước chữ */
            font-weight: 700;
            z-index: 3;
        }

        /* ================================================== */
        /* --- MỚI: GIAO DIỆN QUẢNG CÁO TOÀN MÀN HÌNH --- */
        /* ================================================== */
        #ad-view {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: black; 
            z-index: 200;
        }
        #ad-view .idle-video-background {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #ad-view #ad-video {
            width: 100%; height: 100%; object-fit: cover;
        }
        #ad-view .video-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); 
        }

        /* MỚI: Header cho màn hình quảng cáo */
        .ad-header {
            position: absolute;
            top: 25px;
            left: 25px;
            z-index: 3;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3); 
            padding: 10px 15px;
            border-radius: var(--border-radius-lg);
            backdrop-filter: blur(5px);
        }
        .ad-header .logo {
            width: 45px; height: 45px;
        }
        .ad-header .org-name {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            line-height: 1.3;
        }

        /* ================================================== */
        /* --- MỚI: GIAO DIỆN TỰ PHỤC VỤ (KIOSK MODE) --- */
        /* ================================================== */
        .self-service-kiosk {
            display: none; /* Ẩn trên thiết bị di động theo mặc định */
            margin-top: 2.5em;
            padding-top: 2em;
            border-top: 1px dashed var(--border-color);
            width: 100%; 
            max-width: 600px;
            animation: fadeInUp 0.5s 1s backwards;
        }

        /* Chỉ hiển thị trên màn hình lớn (máy tính) */
        @media (min-width: 1024px) {
            .self-service-kiosk {
                display: block;
            }
        }
 
        #kiosk-plate-input {
            width: 100%;
            padding: 20px;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center; box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            font-family: monospace;
            text-transform: uppercase;
            margin-bottom: 1em;
            transition: all 0.2s;
        }
        #kiosk-plate-input:focus {
            outline: none;
            border-color: var(--primary-accent); 
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        } 
 
        .kiosk-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1em;
        }
        .kiosk-btn {
            padding: 18px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: var(--border-radius-lg);
            cursor: pointer; 
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .kiosk-btn.check-in {
            background-color: var(--primary-accent);
            border-color: var(--primary-accent-light);
            color: white;
        }
        .kiosk-btn.check-out {
            background-color: var(--danger-color);
            border-color: #d43f3a;
            color: white; 
        } 
        .kiosk-btn:hover:not(:disabled) {
            transform: none;
            filter: brightness(1.1);
        }
        .kiosk-btn:disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }

        /* ================================================== */
        /* --- MỚI: BIỂU TƯỢNG ĐANG XỬ LÝ CHO KIOSK --- */
        /* ================================================== */
        .kiosk-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0; 
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(4px);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            border-radius: var(--border-radius-lg);
            animation: fadeIn 0.3s;
        }
        .kiosk-overlay .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-left-color: var(--primary-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .kiosk-overlay p {
            margin-top: 1em;
            font-weight: 600;
            color: var(--text-primary);
        }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
    <!-- MỚI: CSS cho hiệu ứng tiền mặt -->
    <style>  
        .cash-payment-animation {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 1.5em auto;
        }
        .cash-payment-animation .wallet-icon {
            width: 100px;
            height: 100px;
            position: absolute;
            bottom: 0; 
            left: 50%;
            transform: translateX(-50%);
            color: var(--primary-accent);
            z-index: 2;
        }
        .cash-payment-animation .coin {
            position: absolute;
            left: 50%;
            top: -20px;
            width: 25px;
            height: 25px;
            background-color: #ffc107;
            border-radius: 50%;
            border: 2px solid #e6a800;
            animation: drop 2s cubic-bezier(0.6, -0.28, 0.735, 0.045) infinite;
            opacity: 0;
            z-index: 1;
        }
        .cash-payment-animation .coin::before {
            content: '$';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            color: #b45309;
        }
        .cash-payment-animation .coin:nth-child(2) { animation-delay: 0.5s; left: 40%; width: 22px; height: 22px; }
        .cash-payment-animation .coin:nth-child(3) { animation-delay: 1s; left: 60%; width: 28px; height: 28px; }
        .cash-payment-animation .coin:nth-child(4) { animation-delay: 1.5s; left: 55%; }

        @keyframes drop {
            0% { transform: translateY(-20px) scale(1); opacity: 1; }
            100% { transform: translateY(80px) scale(0.5); opacity: 0; }
        }  
    </style>
</head>
<body>
    <!-- 
        LƯU Ý: File này cần có config.js và locations.js trong cùng thư mục để hoạt động.
        Các file này được dùng để lấy API key thời tiết và thông tin các điểm trực.
    -->
    <!-- View 1: Chọn thanh toán -->
    <div id="payment-selection-view" class="confirmation-card hidden">
        <div class="aux-header">
            <div class="header-left">
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-Doan-Thanh-NIen-Cong-San-Ho-Chi-Minh-1.png" alt="Huy hiệu Đoàn" class="logo">
                <div class="org-name">Đoàn TNCS Hồ Chí Minh<br>Phường Ba Đình</div>
            </div>
            <div class="location-info">
                <span class="label">Bãi đỗ xe</span>
                <span class="value" id="header-location-name">--</span>
            </div>
        </div>
        <h1 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            THANH TOÁN PHÍ GỬI XE
        </h1> 

        <!-- ================================================== -->
        <!-- --- BỐ CỤC NGANG MỚI --- -->
        <!-- ================================================== -->
        <div class="payment-content-grid">
            <!-- CỘT TRÁI: THÔNG TIN & LỰA CHỌN -->
            <div class="payment-details-panel">
                <div class="main-info-display">
                    <div class="plate-display" id="payment-plate">--</div>
                    <div class="time-in-display">
                        Giờ vào: <strong id="payment-time-in" style="color: var(--text-primary);">--</strong>
                    </div>
                </div>
                <div class="total-fee-container" style="border-color: var(--danger-color);">
                    <div class="label"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>Tổng phí thanh toán</div>
                    <div class="amount">
                        <span id="payment-total-amount">0</span><sup>đ</sup>
                    </div>
                </div>

                <!-- ================================================== -->
                <!-- --- SỬA LỖI: KHÔI PHỤC NÚT CHỌN PHƯƠNG THỨC THANH TOÁN --- -->
                <!-- ================================================== -->
                <div class="payment-method-selector">
                    <button id="select-qr-btn" class="method-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Thanh toán QR</button>
                    <button id="select-cash-btn" class="method-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>Tiền mặt</button>
                </div>

            </div>

            <!-- CỘT PHẢI: HIỂN THỊ QR HOẶC HƯỚNG DẪN -->
            <div id="right-panel-content" class="payment-right-panel placeholder">
                <!-- NỘI DUNG SẼ ĐƯỢC RENDER BẰNG JAVASCRIPT -->
            </div>
        </div>

        <!-- MỚI: Chuyển nút Hủy giao dịch xuống chân biên lai -->
        <div class="receipt-footer">
            <button id="customer-cancel-btn" class="btn-cancel">Huỷ giao dịch</button>
        </div>
    </div>

    <!-- View 2: Thanh toán thành công -->
    <div id="success-view" class="confirmation-card hidden">
        <div class="success-icon-wrapper">
            <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="success-checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        <h1 class="card-title success" style="margin-bottom: 0;">GIAO DỊCH THÀNH CÔNG</h1> 
        
        <div class="success-main-content">
            <div class="success-amount-display">
                <div class="label">Tổng phí đã thanh toán</div>
                <div class="amount">
                    <span id="success-total-amount">0</span><sup>đ</sup>
                </div>
            </div>
            <div class="success-plate-display" id="success-plate">--</div>
            
            <!-- ================================================== -->
            <!-- --- KHU VỰC CHI TIẾT ĐÃ ĐƯỢC THIẾT KẾ LẠI --- -->
            <!-- ================================================== -->
            <div class="success-details-grid">
                <div class="detail-item">
                    <span class="label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg>Giờ vào</span>
                    <span class="value" id="success-time-in">--</span>
                </div>
                <div class="detail-item">
                    <span class="label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H3v-6"/><path d="M14 10 3 21"/></svg>Giờ ra</span>
                    <span class="value" id="success-time-out">--</span>
                </div>
                <div class="detail-item full-span" style="grid-column: 1 / -1;">
                    <span class="label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>Phương thức</span>
                    <span class="value" id="success-payment-method">--</span>
                </div>
                <div class="success-duration-highlight detail-item">
                    <span class="label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Tổng thời gian</span>
                    <span class="value" id="success-duration">--</span>
                </div>
            </div>
        </div>
        <p class="thank-you-message">Cảm ơn Quý khách & Hẹn gặp lại!</p> 
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="window.close()">Đóng</button>
        </div>
        <p class="auto-close-note">Sẽ tự động chuyển sang màn hình chờ sau 10 giây.</p>
        <div id="confetti-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden;"></div>
    </div>

    <!-- MỚI: View 4 - Gửi xe thành công -->
    <div id="checkin-success-view" class="confirmation-card hidden">
        <div class="success-icon-wrapper">
            <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="success-checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        <h1 class="card-title success" style="margin-bottom: 0.5em;">ĐÃ GỬI XE THÀNH CÔNG</h1>
        <p class="thank-you-message" style="margin-top: 0; margin-bottom: 1.5em;">Vui lòng nhận vé và bảo quản cẩn thận.</p>

        <!-- ================================================== -->
        <!-- --- MỚI: GIAO DIỆN VÉ XE KHI GỬI THÀNH CÔNG --- -->
        <!-- ================================================== -->
        <div class="success-main-content" style="max-width: 380px; margin: 0 auto;">
            <div id="checkin-qrcode-canvas-wrapper" style="padding: 15px; background-color: #fff; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); margin: 0 auto 20px auto; width: 250px; height: 250px;">
                <canvas id="checkin-qrcode-canvas" aria-label="Mã QR của vé xe"></canvas>
            </div>

            <div class="ticket-info-new" style="text-align: left; margin-bottom: 25px;">
                <div class="info-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                    <span class="info-label" style="font-weight: 500; color: var(--text-secondary);">Biển số xe:</span>
                    <span class="info-value" id="checkin-success-plate" style="font-weight: 700; color: var(--text-primary); font-family: monospace; font-size: 1.1rem;">--</span>
                </div>
                <div class="info-row" style="display: flex; justify-content: space-between; padding: 10px 0;">
                    <span class="info-label" style="font-weight: 500; color: var(--text-secondary);">Thời gian vào:</span>
                    <span class="info-value" id="checkin-success-time-in" style="font-weight: 700; color: var(--text-primary);">--</span>
                </div>
            </div>
        </div>

        <p class="auto-close-note" style="margin-top: 2em;">Sẽ tự động chuyển sang màn hình chờ sau 10 giây.</p>
        <div id="checkin-confetti-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden;"></div>
    </div>

    <!-- MỚI: View 3 - Màn hình chờ -->
    <div id="idle-view" class="confirmation-card">
        <!-- NÂNG CẤP: Bố cục ngang hoàn toàn mới -->
        <div class="idle-content-horizontal">
            <div class="idle-header">
                <p class="idle-org-name">ĐOÀN TNCS HỒ CHÍ MINH - PHƯỜNG BA ĐÌNH</p>
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-Doan-Thanh-NIen-Cong-San-Ho-Chi-Minh-1.png" alt="Huy hiệu Đoàn" class="idle-logo">
                <p class="idle-location-name">Bãi đỗ xe: <strong id="idle-location-display">--</strong></p>
            </div>

            <div class="idle-main">
                <!-- CỘT TRÁI: NHẬP LIỆU & HÀNH ĐỘNG -->
                <div class="idle-left-panel">
                    <div class="self-service-kiosk" style="position: relative;">
                        <!-- Lớp phủ xử lý -->
                        <div id="kiosk-processing-overlay" class="kiosk-overlay hidden">
                            <div class="spinner"></div>
                            <p>Đang xử lý, vui lòng chờ...</p>
                        </div>
                        <input type="text" id="kiosk-plate-input" placeholder="NHẬP BIỂN SỐ XE" readonly>
                        <!-- MỚI: Ô nhập số điện thoại, ẩn mặc định -->
                        <div id="kiosk-phone-wrapper" class="hidden" style="margin-bottom: 1em; animation: fadeInUp 0.3s;">
                            <input type="tel" id="kiosk-phone-input" placeholder="Số điện thoại (không bắt buộc)" style="width: 100%; padding: 20px; font-size: 1.5rem; text-align: center; border: 2px solid var(--border-color); border-radius: var(--border-radius-lg); font-family: 'Be Vietnam Pro', sans-serif;">
                        </div>

                        <div class="kiosk-actions">
                            <!-- THAY ĐỔI: Gộp thành một nút duy nhất với hiệu ứng chuyển đổi -->
                            <button id="kiosk-action-btn" class="kiosk-btn" disabled style="position: relative; overflow: hidden;">
                                <span class="btn-text-wrapper" style="display: block; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
                                    <span class="btn-text">NHẬP BIỂN SỐ</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CỘT PHẢI: BÀN PHÍM ẢO -->
                <div class="idle-right-panel">
                    <div class="virtual-keyboard">
                        <button class="kb-btn" data-key="1"><span class="num">1</span><span class="chars"></span></button>
                        <button class="kb-btn" data-key="2"><span class="num">2</span><span class="chars">ABC</span></button>
                        <button class="kb-btn" data-key="3"><span class="num">3</span><span class="chars">DEF</span></button>
                        <button class="kb-btn" data-key="4"><span class="num">4</span><span class="chars">GHI</span></button>
                        <button class="kb-btn" data-key="5"><span class="num">5</span><span class="chars">JKL</span></button>
                        <button class="kb-btn" data-key="6"><span class="num">6</span><span class="chars">MNO</span></button>
                        <button class="kb-btn" data-key="7"><span class="num">7</span><span class="chars">PQRS</span></button>
                        <button class="kb-btn" data-key="8"><span class="num">8</span><span class="chars">TUV</span></button>
                        <button class="kb-btn" data-key="9"><span class="num">9</span><span class="chars">WXYZ</span></button>
                        <button class="kb-btn special danger" data-key="clear">
                            <span class="num">CE</span>
                            <span class="chars">Xóa hết</span>
                        </button>
                        <button class="kb-btn" data-key="0"><span class="num">0</span><span class="chars"></span></button>
                        <button class="kb-btn special" data-key="backspace">
                            <span class="num">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                            </span>
                            <span class="chars">Xóa</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- MỚI: Thêm widget đồng hồ và thời tiết -->
            <div class="idle-widgets">
                <div id="clock-widget" class="clock-widget" title="Thời gian thực">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span id="clock-display">--:--:--</span>
                </div>
                <div id="weather-widget" class="weather-widget" title="Thời tiết tại điểm trực"></div>
            </div>
        </div>
    </div>

    <!-- MỚI: View 5 - Màn hình quảng cáo -->
    <div id="ad-view" class="hidden">
        <!-- Header cho màn hình quảng cáo -->
        <div class="ad-header">
            <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-Doan-Thanh-NIen-Cong-San-Ho-Chi-Minh-1.png" alt="Huy hiệu Đoàn" class="logo"> 
            <div class="org-name">
                ĐOÀN TNCS HỒ CHÍ MINH<br>PHƯỜNG BA ĐÌNH
            </div>
        </div>

        <div class="idle-video-background">
            <video id="ad-video" muted playsinline loop></video>
            <div class="video-overlay"></div>
        </div>
        <div class="idle-footer-bar">
            <!-- Dòng chữ chạy với nội dung và logo đầy đủ -->
            <div class="marquee-text">
                <span>Chương trình Bãi đỗ xe Thanh niên do Đoàn TNCS Hồ Chí Minh Phường Ba Đình</span>
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2021/11/Logo-Doan-Thanh-NIen-Cong-San-Ho-Chi-Minh-1.png" alt="Logo Đoàn Thanh Niên">
                <span>tổ chức, với sự đồng hành của các nhà tài trợ: Vietcombank Ba Đình</span>
                <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/02/Logo-Vietcombank.png" alt="Logo Vietcombank">
                <span>và Vinamilk</span>
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/eb/Logo_Vinamilk_%282023%29.png" alt="Logo Vinamilk">
                <span>. Kính chúc Quý khách một ngày tốt lành!</span>
            </div>
        </div>
        <div id="corner-clock-display" class="corner-clock">--:--:--</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        /**
         * =================================================================
         * HỆ THỐNG QUẢN LÝ MÀN HÌNH PHỤ (CONFIRMATION.HTML) - VIẾT LẠI
         * Phiên bản: 2.0 - Tái cấu trúc toàn bộ
         * Tác giả: Nguyễn Cao Hoàng Quý
         * Mục tiêu: Ổn định, rõ ràng, dễ bảo trì và sửa lỗi triệt để.
         * =================================================================
         */
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. MODULE QUẢN LÝ GIAO DIỆN (UI) ---
            const UI = {
                elements: {
                    paymentView: document.getElementById('payment-selection-view'), 
                    successView: document.getElementById('success-view'), 
                    checkinSuccessView: document.getElementById('checkin-success-view'),
                    idleView: document.getElementById('idle-view'),
                    adView: document.getElementById('ad-view'),
                    adVideo: document.getElementById('ad-video'),
                    selectQrBtn: document.getElementById('select-qr-btn'),
                    selectCashBtn: document.getElementById('select-cash-btn'),
                    rightPanel: document.getElementById('right-panel-content'),
                    paymentGrid: document.querySelector('.payment-content-grid'),
                    kioskInput: document.getElementById('kiosk-plate-input'), // Giữ lại
                    kioskActionBtn: document.getElementById('kiosk-action-btn'), // THAY ĐỔI
                    customerCancelBtn: document.getElementById('customer-cancel-btn'), // MỚI
                    kioskPhoneWrapper: document.getElementById('kiosk-phone-wrapper'), // MỚI
                    kioskPhoneInput: document.getElementById('kiosk-phone-input'), // MỚI
                    kioskOverlay: document.getElementById('kiosk-processing-overlay'),
                },
                views: ['paymentView', 'successView', 'checkinSuccessView', 'idleView', 'adView'],

                // Hiển thị một view cụ thể và ẩn các view khác
                showView(viewName) {
                    this.views.forEach(v => {
                        if (this.elements[v]) {
                            this.elements[v].classList.toggle('hidden', v !== viewName);
                        }
                    });

                    // NÂNG CẤP: Tự động reset kiosk mỗi khi quay về màn hình chờ
                    if (viewName === 'idleView') {
                        this.resetKiosk();
                    }
                },

                // Cập nhật thông tin trên màn hình thanh toán
                updatePaymentView(payload) {
                    this.elements.paymentGrid.classList.remove('method-selected');
                    this.elements.rightPanel.classList.add('placeholder');
                    this.elements.selectQrBtn.classList.remove('active');
                    this.elements.selectCashBtn.classList.remove('active');
                    this.renderRightPanel('placeholder');

                    document.getElementById('payment-total-amount').textContent = payload.totalAmount.replace(/đ/g, '');
                    document.getElementById('payment-plate').textContent = payload.licensePlate;
                    document.getElementById('payment-time-in').textContent = payload.timeIn;
                    if (payload.locationName) this.setLocationName(payload.locationName);
                },

                // Cập nhật thông tin trên màn hình gửi xe thành công
                updateCheckinSuccessView(payload) {
                    document.getElementById('checkin-success-plate').textContent = payload.licensePlate;
                    document.getElementById('checkin-success-time-in').textContent = payload.timeIn;
                    const qrCanvas = document.getElementById('checkin-qrcode-canvas');
                    if (qrCanvas && payload.uniqueID) {
                        QRCode.toCanvas(qrCanvas, payload.uniqueID, { width: 220, errorCorrectionLevel: 'H', margin: 1 }, (error) => {
                            if (error) console.error('Lỗi tạo QR cho màn hình phụ:', error);
                        });
                    }
                },

                // Cập nhật thông tin trên màn hình thanh toán thành công
                updateCheckoutSuccessView(payload) {
                    document.getElementById('success-plate').textContent = payload.licensePlate;
                    document.getElementById('success-time-in').textContent = payload.timeIn;
                    document.getElementById('success-time-out').textContent = payload.timeOut;
                    document.getElementById('success-duration').textContent = payload.duration;
                    document.getElementById('success-payment-method').textContent = payload.paymentMethod;
                    document.getElementById('success-total-amount').textContent = payload.totalAmount.replace(/đ/g, '');
                },

                // Render nội dung cho cột bên phải của màn hình thanh toán
                renderRightPanel(state) {
                    let content = '';
                    switch (state) {
                        case 'qr':
                            content = `<div class="qr-code-display" style="animation: fadeInUp 0.5s ease;"><img id="qr-code-image" src="" alt="Mã QR thanh toán"><p style="margin-top: 15px;">Nội dung: <strong id="qr-memo">--</strong></p></div>`;
                            break;
                        case 'cash':
                            content = `<div style="text-align: center; animation: fadeInUp 0.5s ease;"><div class="cash-payment-animation"><div class="coin"></div><div class="coin"></div><div class="coin"></div><div class="coin"></div><svg class="wallet-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg></div><h3 style="font-size: 1.6rem; color: var(--text-primary); margin-bottom: 0.5em; font-weight: 700;">Thanh toán bằng Tiền mặt</h3><p style="font-size: 1.1rem; color: var(--text-secondary);">Vui lòng đưa tiền cho nhân viên tại quầy.</p></div>`; 
                            break;
                        default:
                            content = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1em; opacity: 0.5;"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 12a10 10 0 0 0 10 10V12z"/></svg>Vui lòng chọn phương thức thanh toán`;
                    }
                    this.elements.rightPanel.innerHTML = content;
                },

                // NÂNG CẤP: Hàm chuyên dụng để reset trạng thái Kiosk
                resetKiosk() {
                    // NÂNG CẤP TRIỆT ĐỂ: Mô phỏng hành động nhấn nút "CE" (clear)
                    const clearButton = document.querySelector('.kb-btn[data-key="clear"]');
                    if (clearButton) {
                        clearButton.click();
                    }
                    // Ẩn lớp phủ xử lý (nếu có)
                    if (this.elements.kioskOverlay) {
                        this.elements.kioskOverlay.classList.add('hidden');
                    }
                    // Reset nút hành động về trạng thái ban đầu
                    this.elements.kioskActionBtn.classList.remove('check-in', 'check-out');
                    this.elements.kioskActionBtn.removeAttribute('data-action');
                    this.elements.kioskActionBtn.disabled = true;
                    this.elements.kioskActionBtn.querySelector('.btn-text').textContent = 'NHẬP BIỂN SỐ';
                    this.elements.kioskPhoneWrapper.classList.add('hidden');
                    this.elements.kioskPhoneInput.value = '';
                },

                // Cập nhật tên bãi đỗ xe
                setLocationName(name) {
                    const decodedName = decodeURIComponent(name);
                    document.getElementById('header-location-name').textContent = decodedName;
                    document.getElementById('idle-location-display').textContent = decodedName;
                },
                // Hiệu ứng confetti
                startConfetti(containerId) {
                    const container = document.getElementById(containerId);
                    if (!container) return; 
                    const confettiCount = 150, colors = ['#0056b3', '#007bff', '#ffc107', '#28a745', '#dc3545'];
                    while (container.firstChild) container.removeChild(container.firstChild);
                    for (let i = 0; i < confettiCount; i++) {
                        const confetti = document.createElement('div'); 
                        confetti.style.cssText = `position: absolute; width: ${Math.random()*10+5}px; height: ${Math.random()*6+4}px; background-color: ${colors[Math.floor(Math.random()*colors.length)]}; top: -10%; left: ${Math.random()*100}%; opacity: 1; transform: rotate(${Math.random()*360}deg);`;
                        container.appendChild(confetti);
                        const angle = Math.random() * 360, radius = Math.random() * 300 + 150;
                        const endX = radius * Math.cos(angle * Math.PI / 180), endY = radius * Math.sin(angle * Math.PI / 180);
                        confetti.animate([ { transform: `translate(0, 0) rotate(${Math.random()*360}deg)`, opacity: 1 }, { transform: `translate(${endX}px, ${endY}px) rotate(${Math.random()*720}deg)`, opacity: 0 } ], { duration: 1500 + Math.random() * 1000, easing: 'cubic-bezier(0.1, 0.9, 0.2, 1)', fill: 'forwards' });
                        setTimeout(() => confetti.remove(), 2500);
                    }
                } 
            };

            // --- 2. MODULE QUẢN LÝ TRẠNG THÁI & HẸN GIỜ ---
            const StateManager = {
                inactivityTimer: null,
                adVideoIndex: 0,
                adPlaylist: APP_CONFIG.adVideos || [],

                startInactivityTimer() {
                    clearTimeout(this.inactivityTimer);
                    this.inactivityTimer = setTimeout(() => {
                        UI.showView('adView'); 
                        this.playNextVideo(); 
                    }, 15000); // 15 giây
                },

                stopInactivityTimerAndAds() {
                    clearTimeout(this.inactivityTimer);
                    if (UI.elements.adVideo && !UI.elements.adVideo.paused) UI.elements.adVideo.pause();
                    UI.showView('idleView');
                },

                resetInactivity() {
                    if (!UI.elements.adView.classList.contains('hidden')) {
                        this.stopInactivityTimerAndAds();
                    }
                    this.startInactivityTimer();
                },

                playNextVideo() {
                    if (this.adPlaylist.length === 0 || !UI.elements.adVideo) return;
                    UI.elements.adVideo.src = this.adPlaylist[this.adVideoIndex];
                    UI.elements.adVideo.play().catch(e => console.error("Lỗi phát video:", e)); 
                    this.adVideoIndex = (this.adVideoIndex + 1) % this.adPlaylist.length;
                }
            };

            // --- 3. MODULE GIAO TIẾP & SỰ KIỆN ---
            const EventHandler = {
                paymentChannel: new BroadcastChannel('parking_payment_channel'),
                // NÂNG CẤP: Quản lý trạng thái T9 tập trung tại đây
                t9Timer: null,
                lastKey: null,
                keyPressCount: 0,

                init() {
                    this.paymentChannel.onmessage = this.handleChannelMessage.bind(this); 
                    this.setupDOMEventListeners();
                },

                // NÂNG CẤP: Hàm chuyên dụng để reset trạng thái T9
                resetT9State() {
                    clearTimeout(this.t9Timer);
                    this.t9Timer = null;
                    this.lastKey = null;
                    this.keyPressCount = 0;
                },

                sendMessage(type, payload = {}) {
                    this.paymentChannel.postMessage({ type, ...payload });
                },

                handleChannelMessage(event) {
                    const { type, payload, method } = event.data;
                    StateManager.resetInactivity(); // Reset timer khi có bất kỳ tin nhắn nào

                    switch (type) {
                        case 'VEHICLE_CHECKOUT_INITIATE':
                            sessionStorage.setItem('lastCheckoutInitiate', JSON.stringify(payload));
                            UI.showView('paymentView');
                            UI.updatePaymentView(payload);

                            // SỬA LỖI TRIỆT ĐỂ: Tự động chọn phương thức QR và hiển thị QR code ngay lập tức
                            if (UI.elements.selectQrBtn) {
                                UI.elements.paymentGrid.classList.add('method-selected');
                                UI.elements.rightPanel.classList.remove('placeholder');
                                UI.elements.selectQrBtn.classList.add('active');
                                UI.elements.selectCashBtn.classList.remove('active');
                                UI.renderRightPanel('qr');
                                if (payload.qrImageUrl) {
                                    document.getElementById('qr-code-image').src = payload.qrImageUrl;
                                    document.getElementById('qr-memo').textContent = payload.paymentMemo;
                                }
                            }

                            this.sendMessage('PLAY_SOUND', { payload: `Cảm ơn quý khách đã sử dụng dịch vụ. Phí gửi xe của quý khách là ${payload.totalAmount.replace('đ', 'đồng')} cho tổng thời gian là ${payload.readableDuration}. Mời quý khách lựa chọn hình thức thanh toán.` });
                            break;

                        case 'VEHICLE_CHECKIN_COMPLETE':
                            UI.showView('checkinSuccessView');
                            UI.updateCheckinSuccessView(payload);
                            UI.startConfetti('checkin-confetti-container');
                            this.sendMessage('PLAY_SOUND', { payload: payload.soundText });
                            setTimeout(() => { UI.showView('idleView'); StateManager.startInactivityTimer(); }, 10000);
                            break;  

                        case 'PAYMENT_METHOD_SELECTED':
                            UI.elements.paymentGrid.classList.add('method-selected');
                            UI.elements.rightPanel.classList.remove('placeholder');
                            const lastMessage = JSON.parse(sessionStorage.getItem('lastCheckoutInitiate'));
                            if (method === 'qr') {
                                UI.elements.selectQrBtn.classList.add('active');
                                UI.elements.selectCashBtn.classList.remove('active');
                                UI.renderRightPanel('qr');
                                if (lastMessage) {
                                    document.getElementById('qr-code-image').src = lastMessage.qrImageUrl;
                                    document.getElementById('qr-memo').textContent = lastMessage.paymentMemo;
                                }
                            } else if (method === 'cash') {
                                UI.elements.selectCashBtn.classList.add('active');
                                UI.elements.selectQrBtn.classList.remove('active');
                                UI.renderRightPanel('cash');
                            }
                            break;

                        case 'CHECKOUT_COMPLETE':
                            UI.showView('successView');
                            UI.updateCheckoutSuccessView(payload);
                            UI.startConfetti('confetti-container');
                            setTimeout(() => { UI.showView('idleView'); StateManager.startInactivityTimer(); }, 10000);  
                            break;

                        case 'TRANSACTION_CANCELED':
                            UI.showView('idleView');
                            StateManager.startInactivityTimer();
                            break;
                    }
                },

                setupDOMEventListeners() {
                    // Sự kiện tương tác chung
                    ['click', 'mousemove', 'touchstart'].forEach(eventType => {
                        window.addEventListener(eventType, () => StateManager.resetInactivity(), { passive: true });
                    });

                    // Nút chọn phương thức thanh toán
                    UI.elements.selectQrBtn.addEventListener('click', () => this.sendMessage('CUSTOMER_PAYMENT_METHOD_SELECTED', { method: 'qr' }));
                    UI.elements.selectCashBtn.addEventListener('click', () => this.sendMessage('CUSTOMER_PAYMENT_METHOD_SELECTED', { method: 'cash' }));

                    // Nút hủy giao dịch trên màn hình phụ
                    if (UI.elements.customerCancelBtn) {
                        UI.elements.customerCancelBtn.addEventListener('click', () => {
                            // Gửi tín hiệu cho màn hình chính
                            this.sendMessage('TRANSACTION_CANCELED');
                            // Chuyển view ngay lập tức, hàm showView sẽ tự động reset kiosk
                            UI.showView('idleView'); 
                        });
                    }

                    // NÂNG CẤP: Xử lý bàn phím ảo
                    const keyboard = document.querySelector('.virtual-keyboard');
                    const t9Map = { '1': '1', '2': '2ABC', '3': '3DEF', '4': '4GHI', '5': '5JKL', '6': '6MNO', '7': '7PQRS', '8': '8TUV', '9': '9WXYZ', '0': '0' };
                    const T9_TIMEOUT = 1200;

                    if (keyboard) {
                         keyboard.addEventListener('click', (e) => {
                            const btn = e.target.closest('.kb-btn');
                            if (!btn) return;
 
                            const key = btn.dataset.key;
                            const input = UI.elements.kioskInput;
 
                            clearTimeout(this.t9Timer); // Xóa bộ đếm thời gian cũ
 
                            if (key === 'backspace') {
                                input.value = input.value.slice(0, -1);
                                this.lastKey = null; // Reset T9 state
                            } else if (key === 'clear') {
                                input.value = '';
                                this.lastKey = null; // Reset T9 state
                            } else if (key === this.lastKey) {
                                // Người dùng bấm lại phím cũ -> xoay vòng ký tự
                                this.keyPressCount++;
                                const chars = t9Map[key];
                                const newChar = chars[this.keyPressCount % chars.length];
                                input.value = input.value.slice(0, -1) + newChar;
                            } else {
                                // Người dùng bấm phím mới
                                this.keyPressCount = 0;
                                this.lastKey = key;
                                const chars = t9Map[key];
                                input.value += chars[0]; // Luôn thêm số trước
                            }
 
                            // Đặt bộ đếm thời gian mới để "chốt" ký tự
                            this.t9Timer = setTimeout(() => {
                                this.lastKey = null;
                            }, T9_TIMEOUT);
 
                            // NÂNG CẤP: Gọi hàm kiểm tra xe thay vì chỉ bật/tắt nút
                            this.handleKioskInput();
                        });
                    }

                    // NÂNG CẤP: Gắn sự kiện cho các nút kiosk
                    UI.elements.kioskActionBtn.addEventListener('click', () => {
                        const btn = UI.elements.kioskActionBtn;
                        const plate = UI.elements.kioskInput.value.toUpperCase();
                        if (!plate) return;

                        const action = btn.dataset.action || '';
                        if (action === 'check-in') {
                            const phone = UI.elements.kioskPhoneInput.value;
                            this.sendMessage('SELF_SERVICE_CHECKIN_REQUEST', { payload: { plate, phone } });
                        } else if (action === 'check-out') {
                            // Gửi yêu cầu hiển thị biên lai / xử lý checkout cho xe đã tìm thấy
                            if (this.foundVehicleData) {
                                this.sendMessage('SHOW_PAYMENT_MODAL_FOR_VEHICLE', { payload: { vehicle: this.foundVehicleData } });
                            }
                        } else {
                            // Không có action hợp lệ — bỏ qua (an toàn)
                            console.warn('Kiosk: no action assigned on button.');
                        }
                    });
                },

                // NÂNG CẤP: Hàm xử lý logic khi người dùng nhập biển số trên kiosk
                async handleKioskInput() {
                    const plate = UI.elements.kioskInput.value.trim().toUpperCase();
                    this.foundVehicleData = null; // Reset dữ liệu xe đã tìm thấy

                    // Reset trạng thái
                    const actionBtn = UI.elements.kioskActionBtn;
                    const btnText = actionBtn.querySelector('.btn-text');

                    actionBtn.classList.remove('check-in', 'check-out');
                    actionBtn.removeAttribute('data-action'); // đảm bảo không còn action cũ
                    actionBtn.disabled = true;
                    UI.elements.kioskPhoneWrapper.classList.add('hidden');

                    if (plate.length < 4) {
                        btnText.textContent = 'NHẬP BIỂN SỐ';
                        return; // Chưa đủ ký tự để tìm
                    }

                    try {
                        // Sử dụng action `getVehicleStatus` mới
                        const response = await fetch(`${APP_CONFIG.googleScriptUrl}?action=getVehicleStatus&plate=${plate}&v=${new Date().getTime()}`);
                        const result = await response.json();

                        // Thêm hiệu ứng chuyển đổi
                        const textWrapper = actionBtn.querySelector('.btn-text-wrapper');
                        textWrapper.style.transform = 'translateY(100%)';

                        // LƯU LẠI DỮ LIỆU XE TÌM THẤY
                        this.foundVehicleData = result.data.vehicle || null;
                        if (result.status === 'success' && result.data.isParking) {
                            // Xe đang gửi
                            setTimeout(() => {
                                // đảm bảo trạng thái hợp lệ và đồng bộ
                                actionBtn.classList.remove('check-in');
                                actionBtn.classList.add('check-out');
                                actionBtn.dataset.action = 'check-out';
                                btnText.textContent = 'LẤY XE';
                                textWrapper.style.transform = 'translateY(0)';
                                actionBtn.disabled = false;
                            }, 150);
                        } else {
                            // Xe không có trong bãi hoặc có lỗi
                            setTimeout(() => {
                                UI.elements.kioskPhoneWrapper.classList.remove('hidden');
                                actionBtn.classList.remove('check-out');
                                actionBtn.classList.add('check-in');
                                actionBtn.dataset.action = 'check-in';
                                btnText.textContent = 'GỬI XE';
                                textWrapper.style.transform = 'translateY(0)';
                                actionBtn.disabled = false;
                            }, 150);
                        }
                    } catch (error) {
                        console.error("Lỗi kiểm tra trạng thái xe:", error);
                        // Nếu có lỗi mạng, mặc định hiển thị form gửi xe mới
                        UI.elements.kioskPhoneWrapper.classList.remove('hidden');
                        actionBtn.classList.remove('check-out');
                        actionBtn.classList.add('check-in');
                        actionBtn.dataset.action = 'check-in';
                        btnText.textContent = 'GỬI XE';
                        actionBtn.disabled = false;
                    }
                }
            };
 
            // --- 4. MODULE TIỆN ÍCH & KHỞI TẠO ---
            const App = {
                init() {
                    this.setupClock();
                    this.setupWeather();
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const locationName = urlParams.get('locationName');
                    if (locationName) UI.setLocationName(locationName);
  
                    EventHandler.init();
                    StateManager.startInactivityTimer();
                    UI.showView('idleView');
                },

                setupClock() {
                    const update = () => {
                        const timeString = new Date().toLocaleTimeString('vi-VN', { hour12: false });
                        document.getElementById('clock-display').textContent = timeString;
                        document.getElementById('corner-clock-display').textContent = timeString;
                    }; 
                    update();
                    setInterval(update, 1000);
                },

                async setupWeather() {
                    const weatherWidget = document.getElementById('weather-widget');
                    if (!weatherWidget) return;
                    const urlParams = new URLSearchParams(window.location.search);
                    const lat = urlParams.get('lat'), lon = urlParams.get('lng');
                    const apiKey = APP_CONFIG.weather.apiKey;

                    if (!apiKey || apiKey === "YOUR_OPENWEATHERMAP_API_KEY" || !lat || !lon) {
                        weatherWidget.innerHTML = `<span>Thời tiết không khả dụng</span>`;
                        return; 
                    }
                    try {
                        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=vi`;
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`Lỗi HTTP: ${response.status}`);
                        const data = await response.json();
                        weatherWidget.innerHTML = `<img id="weather-icon" src="https://openweathermap.org/img/wn/${data.weather[0].icon}.png" alt="Thời tiết" style="display: inline;"><span id="weather-temp">${Math.round(data.main.temp)}°C</span><span id="weather-desc">${data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1)}</span>`;
                    } catch (error) {
                        console.error("Lỗi tải thời tiết:", error);
                        weatherWidget.innerHTML = `<span>Lỗi thời tiết</span>`;
                    }
                }
            };

            // --- BẮT ĐẦU CHẠY ỨNG DỤNG ---
            App.init();
        });
    </script>
</body>
</html>
