<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bi√™n lai D·ªãch v·ª•</title>

    <!-- LOAD SCRIPTS IN CORRECT ORDER -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #e9ebee;
        }

        .container {
            width: 100%;
            max-width: 700px;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        .actions {
            text-align: center;
            padding: 20px;
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            max-width: 700px;
            width: 100%;
        }

        .btn-action {
            background-image: linear-gradient(to bottom, #1565c0, #0d47a1);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-action:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }

            .actions {
                display: none;
            }

            .container {
                box-shadow: none;
                border: none;
                max-width: 100%;
                padding: 0;
            }
        }
    </style>
    <script src="security.js"></script> <!-- B·∫¢O M·∫¨T -->
</head>

<body>
    <div class="container" id="receipt-container"></div>

    <div class="actions">
        <button id="download-pdf-btn" class="btn-action">T·∫£i PDF & In</button>
    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const ticketId = params.get('ticketId');

            console.log("üöÄ Receipt Page Loaded. TicketId:", ticketId);

            // Wait for a moment to ensure config.js has initialized global variables if needed
            // (Though script tag order in head usually guarantees execution order)
            if (!window.SUPABASE_DB && window.supabase && APP_CONFIG) {
                console.log("Attempting manual init of SUPABASE_DB");
                window.SUPABASE_DB = supabase.createClient(APP_CONFIG.supabase.url, APP_CONFIG.supabase.anonKey);
            }

            console.log("Checking Supabase connection:", !!window.SUPABASE_DB);

            // 1. L·∫•y m·∫´u bi√™n lai t·ª´ file
            let templateHtml = '';
            try {
                const response = await fetch('receipt_template.html');
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i m·∫´u bi√™n lai.');
                templateHtml = await response.text();
            } catch (error) {
                console.error("Template load error:", error);
                document.body.innerHTML = `<p style="color: red; text-align: center;">L·ªói t·∫£i m·∫´u: ${error.message}</p>`;
                return;
            }

            // 2. Chu·∫©n b·ªã d·ªØ li·ªáu
            const formatDateTime = (d) => d ? new Date(d).toLocaleString('vi-VN') : '--';
            const formatCurrency = (n) => new Intl.NumberFormat('vi-VN').format(n || 0);
            const calculateDuration = (start, end) => {
                if (!start || !end) return '--';
                let diff = Math.floor((new Date(end) - new Date(start)) / 1000);
                if (diff < 0) return '0m';
                const d = Math.floor(diff / 86400); diff %= 86400;
                const h = Math.floor(diff / 3600); diff %= 3600;
                const m = Math.floor(diff / 60);
                return [d > 0 ? `${d}d` : '', h > 0 ? `${h}h` : '', `${m}m`].filter(Boolean).join(' ') || '0m';
            };

            let data = {};

            // --- LOGIC M·ªöI: T·∫£i d·ªØ li·ªáu t·ª´ DB n·∫øu c√≥ ticketId ---
            if (ticketId) {
                if (!window.SUPABASE_DB) {
                    console.error("‚ùå CRITICAL: Supabase DB not initialized.");
                    document.getElementById('receipt-container').innerHTML = `<p style="color: red; text-align: center; padding: 20px;">L·ªói k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng t·∫£i l·∫°i trang.</p>`;
                    return;
                }

                try {
                    document.getElementById('receipt-container').innerHTML = '<p style="text-align:center; padding: 20px;">ƒêang t√¨m d·ªØ li·ªáu h√≥a ƒë∆°n...</p>';

                    console.log("Fetching transaction for unique_id:", ticketId);
                    const { data: transaction, error } = await window.SUPABASE_DB
                        .from('transactions')
                        .select('*')
                        .eq('unique_id', ticketId)
                        .single();

                    if (error) {
                        console.error("Supabase Error:", error);
                        throw error;
                    }

                    if (!transaction) {
                        console.warn("No transaction found for ID:", ticketId);
                        throw new Error("Kh√¥ng t√¨m th·∫•y giao d·ªãch v·ªõi m√£ n√†y. C√≥ th·ªÉ m√£ kh√¥ng ƒë√∫ng ho·∫∑c ƒë√£ b·ªã x√≥a.");
                    }

                    console.log("‚úÖ Transaction found:", transaction);

                    const exitDate = transaction.exit_time ? new Date(transaction.exit_time) : new Date();

                    data = {
                        orgName: APP_CONFIG.organizationName || 'ƒêO√ÄN THANH NI√äN',
                        orgAddress: APP_CONFIG.orgAddress || 'ƒêang c·∫≠p nh·∫≠t',
                        taxId: APP_CONFIG.taxId || 'ƒêang c·∫≠p nh·∫≠t',
                        orgHotline: APP_CONFIG.orgHotline || 'ƒêang c·∫≠p nh·∫≠t',
                        exitDate: exitDate.getDate(),
                        exitMonth: exitDate.getMonth() + 1,
                        exitYear: exitDate.getFullYear(),
                        uniqueID: transaction.unique_id,
                        plate: transaction.plate,
                        vehicleType: transaction.vehicle_type || 'Xe m√°y',
                        entryTimeDisplay: formatDateTime(transaction.entry_time),
                        exitTimeDisplay: formatDateTime(transaction.exit_time),
                        duration: calculateDuration(transaction.entry_time, transaction.exit_time),
                        feeDisplay: formatCurrency(transaction.fee),
                        paymentMethod: transaction.payment_method || 'Ti·ªÅn m·∫∑t',
                        isVip: transaction.is_vip,
                        freeMinutes: APP_CONFIG.fee?.freeMinutes || 15,
                        dayHours: 0,
                        nightHours: 0,
                        dayRateFormatted: formatCurrency(APP_CONFIG.fee?.dayRate || 0),
                        nightRateFormatted: formatCurrency(APP_CONFIG.fee?.nightRate || 0),
                        feeInWords: 'Kh√¥ng'
                    };

                } catch (err) {
                    document.getElementById('receipt-container').innerHTML = `<div style="padding: 20px; text-align: center; color: red;"><h3>L·ªói t·∫£i d·ªØ li·ªáu</h3><p>${err.message}</p></div>`;
                    return;
                }

            } else {
                console.log("Legacy Mode: Reading params from URL");
                // --- LOGIC C≈® (Legacy URL params) ---
                const exitTimeParam = params.get('exitTime');
                const exitDate = exitTimeParam ? new Date(exitTimeParam) : new Date();

                data = {
                    orgName: APP_CONFIG.organizationName || 'ƒêO√ÄN THANH NI√äN',
                    orgAddress: 'ƒêang c·∫≠p nh·∫≠t',
                    taxId: 'ƒêang c·∫≠p nh·∫≠t',
                    orgHotline: 'ƒêang c·∫≠p nh·∫≠t',
                    exitDate: exitDate.getDate(),
                    exitMonth: exitDate.getMonth() + 1,
                    exitYear: exitDate.getFullYear(),
                    uniqueID: params.get('uniqueID'),
                    plate: params.get('plate'),
                    vehicleType: params.get('vehicleType') || 'Xe m√°y',
                    entryTimeDisplay: formatDateTime(params.get('entryTime')),
                    exitTimeDisplay: formatDateTime(params.get('exitTime')),
                    duration: calculateDuration(params.get('entryTime'), params.get('exitTime')),
                    feeDisplay: formatCurrency(params.get('fee')),
                    paymentMethod: params.get('paymentMethod'),
                    isVip: params.get('isVip') === 'true',
                    freeMinutes: APP_CONFIG.fee?.freeMinutes || 15,
                    dayHours: 0,
                    nightHours: 0,
                    dayRateFormatted: formatCurrency(APP_CONFIG.fee?.dayRate || 0),
                    nightRateFormatted: formatCurrency(APP_CONFIG.fee?.nightRate || 0),
                    feeInWords: 'Kh√¥ng'
                };
            }

            console.log("Applying data to template:", data);

            // 3. ƒêi·ªÅn d·ªØ li·ªáu v√†o m·∫´u
            let finalHtml = templateHtml;
            for (const key in data) {
                // Ensure value is safe string and not undefined
                const value = (data[key] === null || data[key] === undefined) ? '' : data[key];
                const regex = new RegExp(`<?= ${key} ?>`, 'g');
                finalHtml = finalHtml.replace(regex, value);
            }

            // 4. X·ª≠ l√Ω logic ƒëi·ªÅu ki·ªán cho ph∆∞∆°ng th·ª©c thanh to√°n
            try {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = finalHtml;
                const paymentDisplay = tempDiv.querySelector('#payment-method-display');

                // Only process if the template actually has this ID and templates
                if (paymentDisplay && tempDiv.querySelector('#payment-vip')) {
                    if (data.paymentMethod === 'VIP' || data.isVip) {
                        paymentDisplay.innerHTML = tempDiv.querySelector('#payment-vip').innerHTML;
                    } else if (data.paymentMethod === 'Mi·ªÖn ph√≠') {
                        paymentDisplay.innerHTML = tempDiv.querySelector('#payment-free').innerHTML;
                    } else {
                        paymentDisplay.innerHTML = tempDiv.querySelector('#payment-normal').innerHTML;
                    }
                }
                finalHtml = tempDiv.innerHTML;
            } catch (e) {
                console.warn("Error processing payment display logic:", e);
                // Continue with raw HTML if specific logic fails
            }

            // 5. Hi·ªÉn th·ªã bi√™n lai ƒë√£ ho√†n ch·ªânh
            document.getElementById('receipt-container').innerHTML = finalHtml;

            // 6. G·∫Øn s·ª± ki·ªán cho n√∫t t·∫£i PDF
            const downloadBtn = document.getElementById('download-pdf-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    downloadBtn.disabled = true;
                    downloadBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                    const element = document.getElementById('receipt-container');
                    document.querySelector('.actions').style.display = 'none';

                    const opt = {
                        margin: [0.3, 0.2, 0.3, 0.2],
                        filename: `BienLai_${data.plate || 'xe'}_${data.uniqueID || 'id'}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().from(element).set(opt).save().then(() => {
                        document.querySelector('.actions').style.display = 'block';
                        downloadBtn.disabled = false;
                        downloadBtn.textContent = 'T·∫£i PDF & In';
                    });
                });
            }
        });
    </script>
</body>

</html>