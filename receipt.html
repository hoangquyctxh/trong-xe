<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biên lai Dịch vụ</title>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Be Vietnam Pro', sans-serif; margin: 0; padding: 20px; color: #333; font-size: 12px; display: flex; flex-direction: column; align-items: center; background-color: #e9ebee; }
      .container { width: 100%; max-width: 700px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); background-color: white; }
      .actions { text-align: center; padding: 20px; background-color: white; border: 1px solid #ccc; border-top: none; max-width: 700px; width: 100%; }
      .btn-action { background-image: linear-gradient(to bottom, #1565c0, #0d47a1); color: white; border: none; padding: 12px 25px; font-size: 1rem; font-weight: bold; cursor: pointer; }
      .btn-action:disabled { background: #ccc; cursor: not-allowed; }
        @media print {
          body { background-color: white; padding: 0; }
          .actions { display: none; }
          .container { box-shadow: none; border: none; max-width: 100%; padding: 0; }
        }
    </style>
</head>
<body>
    <div class="container" id="receipt-container"></div>

    <div class="actions">
        <button id="download-pdf-btn" class="btn-action">Tải PDF & In</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);

            // 1. Lấy mẫu biên lai từ file
            let templateHtml = '';
            try {
                const response = await fetch('receipt_template.html');
                if (!response.ok) throw new Error('Không thể tải mẫu biên lai.');
                templateHtml = await response.text();
            } catch (error) {
                document.body.innerHTML = `<p style="color: red; text-align: center;">${error.message}</p>`;
                return;
            }

            // 2. Chuẩn bị dữ liệu để điền vào mẫu
            const formatDateTime = (d) => d ? new Date(d).toLocaleString('vi-VN') : '--';
            const formatCurrency = (n) => new Intl.NumberFormat('vi-VN').format(n || 0);
            const calculateDuration = (start, end) => {
                if (!start || !end) return '--';
                let diff = Math.floor((new Date(end) - new Date(start)) / 1000);
                if (diff < 0) return '0m';
                const d = Math.floor(diff / 86400); diff %= 86400;
                const h = Math.floor(diff / 3600); diff %= 3600;
                const m = Math.floor(diff / 60);
                return [d > 0 ? `${d}d` : '', h > 0 ? `${h}h` : '', `${m}m`].filter(Boolean).join(' ') || '0m';
            };

            const exitTimeParam = params.get('exitTime');
            const exitDate = exitTimeParam ? new Date(exitTimeParam) : new Date();

            const data = {
                orgName: APP_CONFIG.organizationName || 'ĐOÀN THANH NIÊN',
                orgAddress: 'Đang cập nhật',
                taxId: 'Đang cập nhật',
                orgHotline: 'Đang cập nhật',
                exitDate: exitDate.getDate(),
                exitMonth: exitDate.getMonth() + 1,
                exitYear: exitDate.getFullYear(),
                uniqueID: params.get('uniqueID'),
                plate: params.get('plate'),
                vehicleType: 'Xe máy',
                entryTimeDisplay: formatDateTime(params.get('entryTime')),
                exitTimeDisplay: formatDateTime(params.get('exitTime')),
                duration: calculateDuration(params.get('entryTime'), params.get('exitTime')),
                feeDisplay: formatCurrency(params.get('fee')),
                paymentMethod: params.get('paymentMethod'),
                isVip: params.get('isVip') === 'true',
                freeMinutes: APP_CONFIG.fee.freeMinutes,
                dayHours: 0,
                nightHours: 0,
                dayRateFormatted: formatCurrency(APP_CONFIG.fee.dayRate),
                nightRateFormatted: formatCurrency(APP_CONFIG.fee.nightRate),
                feeInWords: 'Không'
            };

            // 3. Điền dữ liệu vào mẫu
            let finalHtml = templateHtml;
            for (const key in data) {
                const regex = new RegExp(`<?= ${key} ?>`, 'g');
                finalHtml = finalHtml.replace(regex, data[key]);
            }

            // 4. Xử lý logic điều kiện cho phương thức thanh toán
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = finalHtml;
            const paymentDisplay = tempDiv.querySelector('#payment-method-display');
            if (paymentDisplay) {
                if (data.paymentMethod === 'VIP' || data.isVip) {
                    paymentDisplay.innerHTML = tempDiv.querySelector('#payment-vip').innerHTML;
                } else if (data.paymentMethod === 'Miễn phí') {
                    paymentDisplay.innerHTML = tempDiv.querySelector('#payment-free').innerHTML;
                } else {
                    paymentDisplay.innerHTML = tempDiv.querySelector('#payment-normal').innerHTML;
                }
            }
            finalHtml = tempDiv.innerHTML;

            // 5. Hiển thị biên lai đã hoàn chỉnh
            document.getElementById('receipt-container').innerHTML = finalHtml;

            // 6. Gắn sự kiện cho nút tải PDF
            const downloadBtn = document.getElementById('download-pdf-btn');
            downloadBtn.addEventListener('click', () => {
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'Đang xử lý...';
                const element = document.getElementById('receipt-container');
                document.querySelector('.actions').style.display = 'none';

                const opt = {
                    margin: [0.3, 0.2, 0.3, 0.2],
                    filename: `BienLai_${params.get('plate') || 'xe'}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().from(element).set(opt).save().then(() => {
                    document.querySelector('.actions').style.display = 'block';
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'Tải PDF & In';
                });
            });
        });
    </script>
</body>
</html>