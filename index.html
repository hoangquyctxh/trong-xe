<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω B√£i Xe Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- BI·∫æN TO√ÄN C·ª§C --- */
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --text-color: #495057;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        /* --- THI·∫æT L·∫¨P C∆† B·∫¢N --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: auto;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        header .logo {
            font-size: 2rem;
            background-color: #fff;
            width: 60px;
            height: 60px;
            display: grid;
            place-items: center;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        header h1 {
            font-size: 1.8rem;
            color: var(--dark-color);
            font-weight: 700;
        }

        /* --- TH·∫∫ (CARD) --- */
        .card {
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
        }
        .card h2 {
            color: var(--dark-color);
            font-size: 1.3rem;
            margin-bottom: 20px;
        }

        /* --- FORM T∆Ø∆†NG T√ÅC --- */
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .input-wrapper {
            position: relative;
        }
        .input-wrapper svg {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
            width: 20px;
        }
        .input-wrapper input {
            width: 100%;
            padding: 12px 15px 12px 45px; /* Th√™m padding tr√°i cho icon */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Be Vietnam Pro', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-wrapper input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }
        #search-term { text-transform: uppercase; }

        #action-btn {
            width: 100%;
            padding: 14px;
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        #action-btn:hover { transform: translateY(-2px); }
        #action-btn:disabled { background-color: #ced4da; cursor: not-allowed; transform: none; }
        .btn-check-in { background-color: var(--success-color); }
        .btn-check-out { background-color: var(--danger-color); }

        #status-message {
            margin-top: 15px; padding: 12px; border-radius: 8px; font-weight: 500; text-align: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #status-message.visible { opacity: 1; }
        .status-ready { background-color: #e9f7ef; color: #1d6c41; }
        .status-parked { background-color: #fdeded; color: #a12b2b; }

        /* --- DANH S√ÅCH XE --- */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .vehicle-count {
            background-color: var(--light-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary-color);
        }
        .list-content {
            position: relative;
            min-height: 100px;
        }
        #vehicle-list-container { max-height: 40vh; overflow-y: auto; }

        .vehicle-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .vehicle-item:last-child { border-bottom: none; }
        .vehicle-item .icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: grid;
            place-items: center;
        }
        .vehicle-item .info { flex-grow: 1; }
        .vehicle-item .plate { font-weight: 700; font-size: 1.1rem; color: var(--dark-color); }
        .vehicle-item .details { display: flex; gap: 15px; font-size: 0.85rem; color: #6c757d; margin-top: 4px; }
        .vehicle-item .details span { display: flex; align-items: center; gap: 5px; }

        /* --- TR·∫†NG TH√ÅI T·∫¢I & R·ªñNG --- */
        .loader-container {
            position: absolute;
            inset: 0;
            background-color: rgba(255,255,255,0.8);
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        .empty-state svg {
            width: 60px;
            height: 60px;
            color: #ced4da;
            margin-bottom: 15px;
        }
        .empty-state p {
            font-size: 1.1rem;
            font-weight: 500;
            color: #6c757d;
        }

        /* --- RESPONSIVE CHO DI ƒê·ªòNG --- */
        @media (max-width: 600px) {
            body { padding: 10px; }
            header h1 { font-size: 1.5rem; }
            .input-group { grid-template-columns: 1fr; }
            .card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">üÖøÔ∏è</div>
            <h1>B·∫£ng ƒëi·ªÅu khi·ªÉn B√£i xe</h1>
        </header>

        <main>
            <div class="card interactive-card">
                <h2>Ki·ªÉm tra & X·ª≠ l√Ω</h2>
                <form id="vehicle-form">
                    <div class="input-group">
                        <div class="input-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><path d="M12 16h.01"/></svg>
                            <input type="text" id="search-term" placeholder="Nh·∫≠p Bi·ªÉn s·ªë ho·∫∑c SƒêT..." required>
                        </div>
                        <div class="input-wrapper" id="phone-input-wrapper">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                            <input type="tel" id="phone-number" placeholder="S·ªë ƒëi·ªán tho·∫°i (n·∫øu g·ª≠i m·ªõi)...">
                        </div>
                    </div>
                    <button type="submit" id="action-btn" disabled>Nh·∫≠p th√¥ng tin</button>
                </form>
                <div id="status-message"></div>
            </div>

            <div class="card list-card">
                <div class="list-header">
                    <h2>Danh s√°ch xe ƒëang g·ª≠i</h2>
                    <span class="vehicle-count" id="vehicle-count">0 xe</span>
                </div>
                <div class="list-content">
                    <div class="loader-container" id="loader">
                        <div class="spinner"></div>
                    </div>
                    <div id="vehicle-list-container">
                        </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =========================================================================
            // URL Web App c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p s·∫µn
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwZFTXRHo-0i2HknQAV4Ja-7lZsH27VimRnDre7DnCL2j04lkSYI1BTmCKWCvcG-0jnFg/exec';
            // =========================================================================

            const vehicleForm = document.getElementById('vehicle-form');
            const searchTermInput = document.getElementById('search-term');
            const phoneNumberInput = document.getElementById('phone-number');
            const phoneInputWrapper = document.getElementById('phone-input-wrapper');
            const actionBtn = document.getElementById('action-btn');
            const statusMessage = document.getElementById('status-message');
            const vehicleListContainer = document.getElementById('vehicle-list-container');
            const vehicleCountSpan = document.getElementById('vehicle-count');
            const loader = document.getElementById('loader');

            let parkedVehicles = [];

            const fetchParkedVehicles = async () => {
                loader.style.display = 'flex'; // Hi·ªán loader
                vehicleListContainer.innerHTML = '';
                try {
                    const response = await fetch(WEB_APP_URL, { method: 'GET', mode: 'cors' });
                    const result = await response.json();
                    if (result.status === 'success') {
                        parkedVehicles = result.data;
                        renderVehicleList();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    vehicleListContainer.innerHTML = `<p style="color: red; padding: 20px;">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</p>`;
                } finally {
                    loader.style.display = 'none'; // ·∫®n loader
                }
            };

            const renderVehicleList = () => {
                vehicleListContainer.innerHTML = '';
                vehicleCountSpan.textContent = `${parkedVehicles.length} xe`;
                if (parkedVehicles.length === 0) {
                    vehicleListContainer.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9L2 12v9c0 .6.4 1 1 1h2"/><path d="M7 12V2H3v10"/><path d="m16 12 3.1 3.9c.1.1.1.3 0 .4l-1.1.9c-.1.1-.3.1-.4 0L16 16v-4"/><path d="M5 18h3"/><path d="M6 18v-4"/></svg>
                            <p>B√£i xe hi·ªán ƒëang tr·ªëng!</p>
                        </div>`;
                    return;
                }
                parkedVehicles.sort((a, b) => new Date(b.entryTime) - new Date(a.entryTime));
                parkedVehicles.forEach(vehicle => {
                    const vehicleItem = document.createElement('div');
                    vehicleItem.className = 'vehicle-item';
                    const phoneInfo = vehicle.phone ? `<span>üìû ${vehicle.phone}</span>` : '';
                    const carIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 16.5V18a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-1.5"/><path d="M19 12H5a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2Z"/><path d="M10.5 12V4.5a2.5 2.5 0 0 1 5 0V12"/><path d="M6 12V9c0-1.7 1.3-3 3-3h1"/></svg>`;

                    vehicleItem.innerHTML = `
                        <div class="icon">${carIcon}</div>
                        <div class="info">
                            <div class="plate">${vehicle.plate}</div>
                            <div class="details">
                                ${phoneInfo}
                                <span>üïí ${new Date(vehicle.entryTime).toLocaleString('vi-VN')}</span>
                            </div>
                        </div>`;
                    vehicleListContainer.appendChild(vehicleItem);
                });
            };

            const updateFormStatus = () => {
                const searchTerm = searchTermInput.value.trim().toUpperCase();
                statusMessage.textContent = '';
                statusMessage.classList.remove('visible');

                if (!searchTerm) {
                    actionBtn.disabled = true;
                    actionBtn.textContent = 'Nh·∫≠p th√¥ng tin';
                    actionBtn.className = '';
                    phoneInputWrapper.style.display = 'block';
                    return;
                }

                const foundVehicle = parkedVehicles.find(v => v.plate === searchTerm || (v.phone && v.phone === searchTerm));
                actionBtn.disabled = false;

                if (foundVehicle) {
                    actionBtn.textContent = 'X√°c nh·∫≠n cho xe ra';
                    actionBtn.className = 'btn-check-out';
                    statusMessage.textContent = `Xe [${foundVehicle.plate}] c·ªßa SƒêT [${foundVehicle.phone || 'N/A'}] ƒëang c√≥ trong b√£i.`;
                    statusMessage.className = 'status-parked visible';
                    searchTermInput.value = foundVehicle.plate;
                    phoneInputWrapper.style.display = 'none';
                } else {
                    actionBtn.textContent = 'X√°c nh·∫≠n g·ª≠i xe';
                    actionBtn.className = 'btn-check-in';
                    statusMessage.textContent = `Xe [${searchTerm}] ch∆∞a c√≥ trong b√£i, s·∫µn s√†ng ƒë·ªÉ g·ª≠i.`;
                    statusMessage.className = 'status-ready visible';
                    phoneInputWrapper.style.display = 'block';
                }
            };

            const handleVehicleAction = async (plate, phone, action) => {
                actionBtn.disabled = true;
                actionBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ plate, phone, action })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        await fetchParkedVehicles();
                        searchTermInput.value = '';
                        phoneNumberInput.value = '';
                        updateFormStatus();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    alert(`ƒê√£ x·∫£y ra l·ªói: ${error.message}`);
                    actionBtn.disabled = false;
                    updateFormStatus();
                }
            };

            searchTermInput.addEventListener('input', updateFormStatus);
            vehicleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const searchTerm = searchTermInput.value.trim().toUpperCase();
                if (!searchTerm) return;
                const foundVehicle = parkedVehicles.find(v => v.plate === searchTerm || (v.phone && v.phone === searchTerm));
                
                if (foundVehicle) {
                    handleVehicleAction(foundVehicle.plate, '', 'checkOut');
                } else {
                    const phone = phoneNumberInput.value.trim();
                    handleVehicleAction(searchTerm, phone, 'checkIn');
                }
            });

            fetchParkedVehicles();
        });
    </script>
</body>
</html>
