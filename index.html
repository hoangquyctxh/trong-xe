<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý xe Tình nguyện</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- *** FIX: Added Tesseract.js Library Script *** -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        :root {
            --bg-main: #f7f9fc;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --primary-accent: #004494; /* Blue of Doan Thanh Nien */
            --primary-accent-light: #0d5aa7;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius-lg: 0.75rem;
            --border-radius-md: 0.5rem;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: auto; }
        header { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: space-between; 
            align-items: center; 
            gap: 20px; 
            margin-bottom: 30px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid var(--border-color);
        }
        .header-title { display: flex; align-items: center; gap: 15px; }
        .header-title .logo {
            width: 50px;
            height: auto;
        }
        .header-title .logo img { max-width: 100%; height: auto; }
        .title-group { display: flex; flex-direction: column; }
        .header-title .subtitle { 
            font-size: 1rem; 
            color: var(--text-secondary); 
            font-weight: 500; 
            line-height: 1; 
            margin: 0;
        }
        .header-title h1 { 
            font-size: 1.9rem; 
            color: var(--text-primary); 
            font-weight: 700; 
            line-height: 1.2; 
            margin: 0; 
        }
        .date-selector {
            display: flex; align-items: center; gap: 10px; background: var(--bg-card);
            padding: 8px 12px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color);
        }
        .date-selector label { font-weight: 500; color: var(--text-secondary); }
        .date-selector input[type="date"] {
            background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 6px; padding: 5px;
            font-family: 'Be Vietnam Pro', sans-serif; font-size: 0.95rem; color: var(--text-primary);
        }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .card {
            background: var(--bg-card); box-shadow: var(--shadow-md);
            border-radius: var(--border-radius-lg);
            padding: 25px; transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .card h2 { color: var(--text-primary); font-size: 1.25rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .full-width { grid-column: 1 / -1; }
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-wrapper { position: relative; flex-grow: 1; }
        .input-wrapper svg { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); width: 20px; transition: color 0.2s; }
        .input-wrapper input {
            width: 100%; padding: 14px 15px 14px 45px; border: 1px solid var(--border-color); color: var(--text-primary);
            background: #f9fafb; border-radius: var(--border-radius-md);
            font-size: 1rem; transition: background-color 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .input-wrapper input::placeholder { color: #9ca3af; }
        .input-wrapper input:focus { outline: none; background: white; border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(0, 68, 148, 0.2); }
        .input-wrapper input:focus + svg { color: var(--primary-accent); }
        #search-term, #filter-input { text-transform: uppercase; }
        .action-button {
            width: 100%; padding: 14px; border: none; color: white;
            font-size: 1rem; font-weight: 700; border-radius: var(--border-radius-md);
            cursor: pointer; transition: all 0.2s ease-in-out;
        }
        .action-button:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .action-button:disabled { background: #e5e7eb !important; color: #9ca3af !important; cursor: not-allowed; box-shadow: none; transform: none; filter: none; }
        #scan-btn {
            flex-shrink: 0; padding: 12px; border: 1px solid var(--border-color);
            background-color: white; color: var(--text-secondary);
            cursor: pointer; border-radius: var(--border-radius-md); transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #scan-btn:hover:not(:disabled) { background-color: var(--bg-main); color: var(--primary-accent); }
        #scan-btn .spinner-icon { display: none; width: 18px; height: 18px; border: 2px solid var(--primary-accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        #scan-btn.loading .scanner-icon { display: none; }
        #scan-btn.loading .spinner-icon { display: block; }
        .btn-check-in { background: linear-gradient(45deg, var(--primary-accent), var(--primary-accent-light)); box-shadow: 0 4px 15px 0 rgba(0, 68, 148, 0.3); }
        .btn-check-out { background: linear-gradient(45deg, var(--danger-color), #fb7185); box-shadow: 0 4px 15px 0 rgba(239, 68, 68, 0.3); }
        #vehicle-info-panel { display: none; animation: slideDown 0.5s ease; margin-top: 20px; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .dashboard-grid, .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-item { background: var(--bg-main); padding: 15px; border-radius: var(--border-radius-md); }
        .info-item .label { font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .info-item .value { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .status-badge { font-size: 1rem; font-weight: 700; padding: 4px 10px; border-radius: 20px; color: white; }
        .status-badge.parking { background-color: var(--success-color); }
        .status-badge.not-parking { background-color: var(--text-secondary); }
        .list-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 15px; }
        #vehicle-list-container { max-height: 50vh; overflow-y: auto; padding-right: 5px; }
        .vehicle-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: var(--border-radius-md); margin-bottom: 10px; border: 1px solid var(--border-color); transition: all 0.3s ease; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .vehicle-item:hover { transform: translateX(5px); border-color: var(--primary-accent); }
        .skeleton-item { background: #e5e7eb; border-radius: var(--border-radius-md); height: 85px; margin-bottom: 10px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: var(--border-radius-md); color: white; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 10px; animation: slideUp 0.3s ease, fadeOutToast 0.5s ease 2.5s forwards; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: scale(0.9); } }
        
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: var(--border-radius-lg); width: 90%; max-width: 500px; text-align: center; box-shadow: var(--shadow-lg); animation: zoomIn 0.3s ease; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #camera-feed { width: 100%; max-height: 60vh; border-radius: var(--border-radius-md); margin-bottom: 15px; }
        #ocr-progress-container { margin-bottom: 10px; }
        #ocr-progress-bar { width: 100%; height: 10px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; }
        #ocr-progress-fill { width: 0%; height: 100%; background-color: var(--primary-accent); transition: width 0.2s; }
        #ocr-status-text { font-weight: 500; color: var(--text-secondary); }

        @media (max-width: 820px) { .main-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { header { flex-direction: column; align-items: flex-start; } .date-selector { width: 100%; justify-content: space-between; } }
        @media (max-width: 600px) { .input-group { flex-direction: column; } .card { padding: 20px; } .info-grid, .dashboard-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="container">
        <header>
            <div class="header-title">
                <div class="logo">
                    <img src="https://upload.wikimedia.org/wikipedia/vi/0/09/Huy_Hi%E1%BB%87u_%C4%90o%C3%A0n.png" alt="Huy hiệu Đoàn">
                </div>
                <div class="title-group">
                    <p class="subtitle">Đoàn Thanh niên Phường Ba Đình</p>
                    <h1>Hệ thống Quản lý xe</h1>
                </div>
            </div>
            <div class="date-selector">
                <label for="date-picker">Xem ngày:</label>
                <input type="date" id="date-picker">
            </div>
        </header>

        <main class="main-grid">
            <div class="card">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/><path d="m10 12-4 4"/><path d="M12 10h6"/><path d="m14 8 2 2-2 2"/><path d="m6 14 2 2-2 2"/></svg>
                    Tra cứu & Xử lý
                </h2>
                <form id="main-form" autocomplete="off">
                    <div class="input-group">
                        <div class="input-wrapper">
                            <input type="text" id="search-term" placeholder="Nhập Biển số xe..." required>
                        </div>
                        <button type="button" id="scan-btn" title="Quét biển số bằng camera">
                           <span class="spinner-icon"></span>
                           <svg class="scanner-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                           <span id="scan-btn-text">Quét Biển Số</span>
                        </button>
                    </div>
                     <div class="input-wrapper" id="phone-item-main" style="margin-bottom: 15px;">
                        <input type="tel" id="phone-number" placeholder="Số điện thoại (nếu gửi mới)...">
                    </div>
                    <button type="submit" id="action-btn" class="action-button" disabled>Nhập biển số để tiếp tục</button>
                </form>

                <div id="vehicle-info-panel">
                    <h3 style="color:var(--text-primary); margin-top: 20px; font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Thông tin chi tiết</h3>
                    <div class="info-grid" style="margin-top: 15px;">
                        <div class="info-item">
                            <div class="label">Trạng thái</div>
                            <div class="value" id="info-status">--</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Giờ vào</div>
                            <div class="value" id="info-entry-time">--</div>
                        </div>
                        <div class="info-item" id="duration-item">
                            <div class="label">Thời gian gửi</div>
                            <div class="value info-duration" id="info-duration">--</div>
                        </div>
                    </div>
                    <h3 style="color:var(--text-primary); margin-top: 20px; font-size: 1rem;">Lịch sử gửi xe</h3>
                    <ul class="history-list" id="info-history-list"></ul>
                </div>
            </div>

            <div class="card">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8a2 2 0 0 1 0 2.8l-6 6-3.4-3.4-3-3a2 2 0 0 1 0-2.8l6-6a2 2 0 0 1 2.8 0z"/></svg>
                    Bảng tin nhanh
                </h2>
                <div class="dashboard-grid">
                    <div class="info-item">
                        <div class="label">Xe hiện tại</div>
                        <div class="value" id="dashboard-current">0</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Tổng lượt trong ngày</div>
                        <div class="value" id="dashboard-total">0</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Giờ cao điểm (vào)</div>
                        <div class="value" id="dashboard-peak">--</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Xe gửi lâu nhất</div>
                        <div class="value info-duration" id="dashboard-longest">--</div>
                    </div>
                </div>
            </div>
            
            <div class="card full-width">
                 <div class="list-header">
                    <h2 id="list-title">Danh sách xe</h2>
                    <div class="input-wrapper" style="max-width: 300px;">
                         <input type="text" id="filter-input" placeholder="Lọc danh sách theo biển số, SĐT...">
                    </div>
                 </div>
                <div class="list-content">
                    <div id="vehicle-list-container"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="camera-modal" class="modal">
        <div class="modal-content">
            <h3>Căn chỉnh biển số vào khung hình</h3>
            <video id="camera-feed" playsinline></video>
            <div id="ocr-progress-container">
                <div id="ocr-status-text">Sẵn sàng quét</div>
                <div id="ocr-progress-bar">
                    <div id="ocr-progress-fill"></div>
                </div>
            </div>
            <button type="button" id="capture-btn" class="action-button btn-check-in">Chụp & Quét</button>
            <button type="button" id="close-camera-btn" class="action-button" style="background: #6c757d; margin-top: 10px;">Đóng</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZFTXRHo-0i2HknQAV4Ja-7lZsH27VimRnDre7DnCL2j04lkSYI1BTmCKWCvcG-0jnFg/exec';
            
            const allElements = {
                datePicker: document.getElementById('date-picker'),
                mainForm: document.getElementById('main-form'),
                searchTermInput: document.getElementById('search-term'),
                phoneNumberInput: document.getElementById('phone-number'),
                phoneItemMain: document.getElementById('phone-item-main'),
                actionBtn: document.getElementById('action-btn'),
                toastContainer: document.getElementById('toast-container'),
                vehicleInfoPanel: document.getElementById('vehicle-info-panel'),
                infoStatus: document.getElementById('info-status'),
                infoEntryTime: document.getElementById('info-entry-time'),
                infoDuration: document.getElementById('info-duration'),
                durationItem: document.getElementById('duration-item'),
                infoHistoryList: document.getElementById('info-history-list'),
                listTitle: document.getElementById('list-title'),
                vehicleListContainer: document.getElementById('vehicle-list-container'),
                filterInput: document.getElementById('filter-input'),
                dashboardCurrent: document.getElementById('dashboard-current'),
                dashboardTotal: document.getElementById('dashboard-total'),
                dashboardPeak: document.getElementById('dashboard-peak'),
                dashboardLongest: document.getElementById('dashboard-longest'),
                scanBtn: document.getElementById('scan-btn'),
                scanBtnText: document.getElementById('scan-btn-text'),
                cameraModal: document.getElementById('camera-modal'),
                cameraFeed: document.getElementById('camera-feed'),
                captureBtn: document.getElementById('capture-btn'),
                closeCameraBtn: document.getElementById('close-camera-btn'),
                ocrStatusText: document.getElementById('ocr-status-text'),
                ocrProgressFill: document.getElementById('ocr-progress-fill'),
                ocrProgressContainer: document.getElementById('ocr-progress-container'),
            };

            let vehiclesOnSelectedDate = [];
            let isLoading = false;
            let durationIntervals = [];
            let cameraStream = null;
            let currentVehicleContext = null;
            let tesseractWorker = null;

            const initializeAI = async () => {
                allElements.scanBtn.classList.add('loading');
                allElements.scanBtnText.textContent = 'Đang tải AI...';
                allElements.scanBtn.disabled = true;
                try {
                    tesseractWorker = await Tesseract.createWorker('eng', 1, {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                allElements.ocrStatusText.textContent = `Đang nhận diện... ${Math.round(m.progress * 100)}%`;
                                allElements.ocrProgressFill.style.width = `${m.progress * 100}%`;
                            }
                        }
                    });
                    await tesseractWorker.setParameters({
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
                    });
                    showToast('Lõi AI đã sẵn sàng!', 'success');
                    allElements.scanBtn.classList.remove('loading');
                    allElements.scanBtnText.textContent = 'Quét Biển Số';
                    allElements.scanBtn.disabled = false;
                } catch (error) {
                    showToast('Không thể tải Lõi AI. Vui lòng kiểm tra mạng và tải lại trang.', 'error');
                    allElements.scanBtnText.textContent = 'Lỗi tải AI';
                    console.error('Tesseract worker creation failed:', error);
                }
            };
            
            const setIsLoading = (loading, actionText = 'Đang xử lý...') => {
                isLoading = loading;
                const interactiveElements = [allElements.actionBtn, allElements.searchTermInput, allElements.phoneNumberInput, allElements.datePicker, allElements.filterInput, allElements.captureBtn];
                if(tesseractWorker) allElements.scanBtn.disabled = loading;
                interactiveElements.forEach(el => { if (el) el.disabled = loading; });
                if (loading) {
                    if (document.activeElement === allElements.actionBtn) {
                        allElements.actionBtn.textContent = actionText;
                    }
                }
            };

            const formatDateForAPI = (date) => date.toISOString().split('T')[0];
            const formatDateTimeForDisplay = (dateStr) => dateStr ? new Date(dateStr).toLocaleString('vi-VN') : '--';
            const cleanPlateNumber = (plateStr) => plateStr ? plateStr.toUpperCase().replace(/[^A-Z0-9]/g, '') : '';
            
            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icon = type === 'success' ? '✅' : '❌';
                toast.innerHTML = `${icon} <span>${message}</span>`;
                allElements.toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'fadeOutToast 0.5s ease forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 2500);
            };

            const calculateDuration = (startTime) => {
                const start = new Date(startTime);
                const now = new Date();
                let diff = Math.floor((now - start) / 1000);
                const days = Math.floor(diff / 86400); diff %= 86400;
                const hours = Math.floor(diff / 3600); diff %= 3600;
                const minutes = Math.floor(diff / 60); const seconds = diff % 60;
                let result = '';
                if (days > 0) result += `${days}d `;
                if (hours > 0) result += `${hours}h `;
                result += `${minutes}m ${seconds}s`;
                return result.trim();
            };
            const clearAllIntervals = () => {
                durationIntervals.forEach(clearInterval);
                durationIntervals = [];
            };

            const fetchVehiclesForDate = async (dateStr) => {
                if (isLoading) return;
                setIsLoading(true);
                showSkeletonLoader();
                allElements.listTitle.textContent = `Danh sách xe ngày ${new Date(dateStr).toLocaleDateString('vi-VN')}`;
                try {
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?date=${dateStr}`, { method: 'GET', mode: 'cors' });
                    const result = await response.json();
                    if (result.status === 'success') {
                        vehiclesOnSelectedDate = result.data;
                        filterVehicleList();
                        updateDashboard();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showToast(`Lỗi tải dữ liệu: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const fetchVehicleHistory = (plate) => {
                fetch(`${GOOGLE_SCRIPT_URL}?plate=${plate}`, { method: 'GET', mode: 'cors' })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 'success') {
                            populateHistoryList(result.data);
                        } else { throw new Error(result.message); }
                    })
                    .catch(error => {
                        console.error("Lỗi tải lịch sử:", error);
                        document.getElementById('info-history-list').innerHTML = `<li class="history-item" style="color: var(--danger-color);">Không thể tải lịch sử.</li>`;
                    });
            };
            
            const showSkeletonLoader = () => {
                allElements.vehicleListContainer.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'skeleton-item';
                    allElements.vehicleListContainer.appendChild(skeleton);
                }
            };
            const renderVehicleList = (list) => {
                allElements.vehicleListContainer.innerHTML = '';
                if (list.length === 0) {
                    allElements.vehicleListContainer.innerHTML = `<div class="empty-state" style="color: var(--text-secondary); text-align: center; padding: 40px 0;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem;"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9L2 12v9c0 .6.4 1 1 1h2"/><path d="M7 12V2H3v10"/><path d="m16 12 3.1 3.9c.1.1.1.3 0 .4l-1.1.9c-.1.1-.3.1-.4 0L16 16v-4"/><path d="M5 18h3"/><path d="M6 18v-4"/></svg><p>Không có xe nào trong danh sách.</p></div>`;
                    return;
                }
                list.sort((a, b) => new Date(b.entryTime) - new Date(a.entryTime));
                list.forEach(vehicle => {
                    const vehicleItem = document.createElement('div');
                    vehicleItem.className = 'vehicle-item';
                    const phoneInfo = vehicle.phone ? `<span>📞 ${vehicle.phone}</span>` : '';
                    const statusClass = vehicle.status === 'Đang gửi' ? 'parking' : 'departed';
                    const statusBadge = `<span class="status-badge ${statusClass}">${vehicle.status}</span>`;
                    const carIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19.94,10.25a2.5,2.5,0,0,0-4.88,0H4.06a2.5,2.5,0,0,0-4.88,0H0v10H24V10.25ZM6,14.75a1.5,1.5,0,1,1,1.5,1.5A1.5,1.5,0,0,1,6,14.75Zm12,0a1.5,1.5,0,1,1,1.5,1.5A1.5,1.5,0,0,1,18,14.75Z"/></svg>`;
                    vehicleItem.innerHTML = `<div class="icon" style="background: transparent; color: var(--text-secondary);">${carIcon}</div><div class="info"><div class="plate" style="color: var(--text-primary);">${vehicle.plate} ${statusBadge}</div><div class="details" style="color: var(--text-secondary);">${phoneInfo}<span>🕒 ${formatDateTimeForDisplay(vehicle.entryTime)}</span></div></div>`;
                    allElements.vehicleListContainer.appendChild(vehicleItem);
                });
            };
            const filterVehicleList = () => {
                const filterText = cleanPlateNumber(allElements.filterInput.value);
                if (!filterText) { renderVehicleList(vehiclesOnSelectedDate); return; }
                const filteredList = vehiclesOnSelectedDate.filter(v => 
                    cleanPlateNumber(v.plate).includes(filterText) || (v.phone && v.phone.includes(filterText))
                );
                renderVehicleList(filteredList);
            };
            const updateDashboard = () => {
                const currentVehicles = vehiclesOnSelectedDate.filter(v => v.status === 'Đang gửi');
                allElements.dashboardCurrent.textContent = currentVehicles.length;
                allElements.dashboardTotal.textContent = vehiclesOnSelectedDate.length;
                if (vehiclesOnSelectedDate.length > 0) {
                    const hours = vehiclesOnSelectedDate.map(v => new Date(v.entryTime).getHours());
                    const hourCounts = hours.reduce((acc, hour) => { acc[hour] = (acc[hour] || 0) + 1; return acc; }, {});
                    const peakHour = Object.keys(hourCounts).length > 0 ? Object.keys(hourCounts).reduce((a, b) => hourCounts[a] > hourCounts[b] ? a : b) : '--';
                    allElements.dashboardPeak.textContent = peakHour !== '--' ? `${peakHour}h - ${parseInt(peakHour) + 1}h` : '--';
                } else { allElements.dashboardPeak.textContent = '--'; }
                if (currentVehicles.length > 0) {
                    const longest = currentVehicles.reduce((a, b) => new Date(a.entryTime) < new Date(b.entryTime) ? a : b);
                    allElements.dashboardLongest.textContent = calculateDuration(longest.entryTime);
                } else { allElements.dashboardLongest.textContent = '--'; }
            };

            const updateUIFromCache = (plate) => {
                clearAllIntervals();
                const vehicleInCache = vehiclesOnSelectedDate.find(v => v.plate === plate && v.status === 'Đang gửi');

                if (vehicleInCache) {
                    currentVehicleContext = { plate, status: 'parking' };
                    allElements.vehicleInfoPanel.style.display = 'block';
                    allElements.phoneItemMain.style.display = 'none';
                    allElements.infoStatus.innerHTML = `<span class="status-badge parking">Đang gửi</span>`;
                    allElements.infoEntryTime.textContent = formatDateTimeForDisplay(vehicleInCache.entryTime);
                    allElements.durationItem.style.display = 'grid';
                    const interval = setInterval(() => allElements.infoDuration.textContent = calculateDuration(vehicleInCache.entryTime), 1000);
                    durationIntervals.push(interval);
                    allElements.actionBtn.textContent = 'Xác nhận cho xe ra';
                    allElements.actionBtn.className = 'action-button btn-check-out';
                } else {
                    currentVehicleContext = { plate, status: 'new' };
                    allElements.vehicleInfoPanel.style.display = 'none';
                    allElements.phoneItemMain.style.display = 'block';
                    allElements.actionBtn.textContent = 'Xác nhận gửi xe';
                    allElements.actionBtn.className = 'action-button btn-check-in';
                }
                
                allElements.actionBtn.disabled = false;
                
                fetchVehicleHistory(plate);
            };

            const populateHistoryList = (history) => {
                const historyList = document.getElementById('info-history-list');
                historyList.innerHTML = '';
                if (history.length > 0) {
                    if(currentVehicleContext && currentVehicleContext.status === 'new') {
                        allElements.vehicleInfoPanel.style.display = 'block';
                        allElements.phoneNumberInput.value = history[0]?.phone || '';
                    }
                    history.slice(0, 5).forEach(entry => {
                        const li = document.createElement('li');
                        li.className = 'history-item';
                        li.innerHTML = `<span>▶️ <strong>Vào:</strong> ${formatDateTimeForDisplay(entry.entryTime)}</span><span>◀️ <strong>Ra:</strong> ${formatDateTimeForDisplay(entry.exitTime)}</span>`;
                        historyList.appendChild(li);
                    });
                } else {
                    historyList.innerHTML = `<li class="history-item" style="color: var(--text-secondary);">Chưa có lịch sử.</li>`;
                }
            }

            const resetMainForm = () => {
                allElements.vehicleInfoPanel.style.display = 'none';
                allElements.phoneItemMain.style.display = 'block';
                allElements.actionBtn.disabled = true;
                allElements.actionBtn.textContent = 'Nhập biển số để tiếp tục';
                allElements.actionBtn.className = 'action-button';
                currentVehicleContext = null;
                clearAllIntervals();
            };

            const handleVehicleAction = async (plate, phone, action) => {
                if (isLoading) return;
                plate = cleanPlateNumber(plate);
                if(!plate) { showToast("Biển số không hợp lệ.", 'error'); return; }
                setIsLoading(true, 'Đang gửi...');
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ plate, phone, action })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showToast(result.message, 'success');
                        allElements.mainForm.reset();
                        resetMainForm();
                        await fetchVehiclesForDate(allElements.datePicker.value);
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showToast(`Lỗi: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const openCamera = async () => {
                if (!tesseractWorker) { showToast('Lõi AI chưa sẵn sàng, vui lòng đợi.', 'error'); return; }
                if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
                    showToast('Trình duyệt không hỗ trợ camera.', 'error'); return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    allElements.cameraFeed.srcObject = stream;
                    cameraStream = stream;
                    allElements.cameraModal.style.display = 'flex';
                    allElements.cameraFeed.play();
                } catch(err) {
                    showToast('Không thể truy cập camera. Vui lòng cấp quyền.', 'error');
                    console.error(err);
                }
            };

            const closeCamera = () => {
                if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); }
                allElements.cameraModal.style.display = 'none';
            };
            
            const performOcrScan = async () => {
                if (!cameraStream || isLoading || !tesseractWorker) return;
                setIsLoading(true, 'Đang quét...');
                allElements.ocrProgressContainer.style.display = 'block';
                
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = allElements.cameraFeed.videoWidth;
                    canvas.height = allElements.cameraFeed.videoHeight;
                    canvas.getContext('2d').drawImage(allElements.cameraFeed, 0, 0, canvas.width, canvas.height);
                    
                    const result = await tesseractWorker.recognize(canvas);
                    
                    let plate = cleanPlateNumber(result.data.text);
                    
                    if (plate.length >= 6 && plate.length <= 9) {
                        allElements.searchTermInput.value = plate;
                        showToast(`Nhận diện: ${plate}`, 'success');
                        allElements.searchTermInput.dispatchEvent(new Event('input', { bubbles: true }));
                    } else {
                        showToast("Không nhận diện rõ ràng, thử lại hoặc chụp gần biển số.", "error");
                    }
                } catch (error) {
                    showToast("Có lỗi khi nhận diện biển số.", "error");
                    console.error(error);
                } finally {
                    setIsLoading(false);
                    closeCamera();
                }
            };

            // Event Listeners
            allElements.datePicker.addEventListener('change', () => fetchVehiclesForDate(allElements.datePicker.value));
            allElements.mainForm.addEventListener('submit', (e) => {
                e.preventDefault();
                let plateToSubmit = cleanPlateNumber(allElements.searchTermInput.value);
                let phoneToSubmit = allElements.phoneNumberInput.value.trim();
                let action;

                if (currentVehicleContext) {
                    plateToSubmit = currentVehicleContext.plate;
                    if (currentVehicleContext.status === 'parking') {
                        action = 'checkOut';
                        phoneToSubmit = '';
                    } else {
                        action = 'checkIn';
                    }
                } else {
                     action = 'checkIn';
                }
                handleVehicleAction(plateToSubmit, phoneToSubmit, action);
            });

            allElements.searchTermInput.addEventListener('input', () => {
                const plate = cleanPlateNumber(allElements.searchTermInput.value);
                if (plate.length >= 6) {
                    updateUIFromCache(plate);
                } else {
                    resetMainForm();
                }
            });

            allElements.filterInput.addEventListener('input', filterVehicleList);
            allElements.scanBtn.addEventListener('click', openCamera);
            allElements.closeCameraBtn.addEventListener('click', closeCamera);
            allElements.captureBtn.addEventListener('click', performOcrScan);
            
            // --- INITIALIZATION ---
            const initializeApp = async () => {
                await initializeAI();
                allElements.datePicker.value = formatDateForAPI(new Date());
                await fetchVehiclesForDate(allElements.datePicker.value);
                resetMainForm();
            }

            initializeApp();
        });
    </script>
</body>
</html>

