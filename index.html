<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω xe Thanh ni√™n T√¨nh nguy·ªán</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tesseract.js Library -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        :root {
            --doan-blue: #004494; --doan-blue-dark: #00336e; --doan-yellow: #ffd700;
            --flame-red: #ff4757; --success-color: #2ecc71; --light-color: #f8f9fa;
            --dark-color: #212529; --text-color-light: #f1f3f4;
            --border-color: rgba(255, 255, 255, 0.2); --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            --border-radius-lg: 16px; --border-radius-md: 10px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        @keyframes gradientAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body {
            font-family: 'Be Vietnam Pro', sans-serif; color: var(--text-color); line-height: 1.6; padding: 20px;
            background: linear-gradient(-45deg, var(--doan-blue), var(--doan-blue-dark), #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientAnimation 15s ease infinite;
        }
        .container { max-width: 1000px; margin: auto; }
        header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 30px; }
        .header-title { display: flex; align-items: center; gap: 15px; }
        .header-title .logo {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            border-radius: 50%; border: 1px solid var(--border-color); width: 60px; height: 60px;
            display: grid; place-items: center; padding: 8px;
        }
        .header-title .logo img { max-width: 100%; height: auto; }
        .header-title h1 { font-size: 1.6rem; color: white; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .date-selector {
            display: flex; align-items: center; gap: 10px; background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); padding: 8px 12px;
            border-radius: var(--border-radius-md); border: 1px solid var(--border-color);
        }
        .date-selector label { font-weight: 500; color: white; }
        .date-selector input[type="date"] {
            background: rgba(255, 255, 255, 0.2); border: none; border-radius: 6px; padding: 5px;
            font-family: 'Be Vietnam Pro', sans-serif; font-size: 0.95rem; color: white;
        }
        .main-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 25px; }
        .card {
            background: rgba(255, 255, 255, 0.1); box-shadow: var(--shadow);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius-lg); border: 1px solid var(--border-color);
            padding: 25px; transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 32px 0 rgba(0, 0, 0, 0.2); }
        .card h2 { color: white; font-size: 1.3rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .full-width { grid-column: 1 / -1; }
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-wrapper { position: relative; flex-grow: 1; }
        .input-wrapper svg { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.6); width: 20px; transition: color 0.2s; }
        .input-wrapper input {
            width: 100%; padding: 14px 15px 14px 45px; border: none; color: white;
            background: rgba(0, 0, 0, 0.2); border-radius: var(--border-radius-md);
            font-size: 1rem; transition: background-color 0.2s, box-shadow 0.2s;
        }
        .input-wrapper input::placeholder { color: rgba(255, 255, 255, 0.6); }
        .input-wrapper input:focus { outline: none; background: rgba(0, 0, 0, 0.3); box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3); }
        .input-wrapper input:focus + svg { color: var(--doan-yellow); }
        #search-term, #filter-input { text-transform: uppercase; }
        .action-button {
            width: 100%; padding: 14px; border: none; color: white;
            font-size: 1rem; font-weight: 700; border-radius: var(--border-radius-md);
            cursor: pointer; transition: all 0.2s ease-in-out;
        }
        .action-button:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .action-button:disabled { background: #ced4da !important; color: #6c757d !important; cursor: not-allowed; box-shadow: none; transform: none; filter: none; }
        #scan-btn {
            flex-shrink: 0; padding: 12px; border: 1px solid var(--border-color);
            background-color: rgba(255, 255, 255, 0.8); color: var(--doan-blue);
            cursor: pointer; border-radius: var(--border-radius-md); transition: all 0.2s ease;
        }
        .btn-check-in { background: linear-gradient(45deg, var(--doan-blue), var(--doan-blue-dark)); box-shadow: 0 4px 15px 0 rgba(0, 68, 148, 0.4); }
        .btn-check-out { background: linear-gradient(45deg, var(--flame-red), #ff6b81); box-shadow: 0 4px 15px 0 rgba(255, 71, 87, 0.4); }
        #vehicle-info-panel { display: none; animation: slideDown 0.5s ease; margin-top: 20px; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .dashboard-grid, .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: var(--border-radius-md); }
        .info-item .label { font-size: 0.8rem; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 5px; }
        .info-item .value { font-size: 1.4rem; font-weight: 700; color: white; }
        #info-duration.value { font-size: 1.1rem; }
        .status-badge { font-size: 1rem; font-weight: 700; padding: 4px 10px; border-radius: 20px; color: white; }
        .status-badge.parking { background-color: var(--success-color); }
        .status-badge.not-parking { background-color: #6c757d; }
        .history-list { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; margin-top: 15px; }
        .history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; color: var(--text-color-light); }
        .history-item:last-child { border-bottom: none; }
        .list-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 15px; }
        #vehicle-list-container { max-height: 50vh; overflow-y: auto; padding-right: 5px; }
        .vehicle-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: var(--border-radius-md); margin-bottom: 10px; transition: all 0.3s ease; animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .vehicle-item:hover { transform: translateX(5px); background: rgba(255, 255, 255, 0.2); }
        .skeleton-item { background: rgba(255,255,255,0.1); border-radius: var(--border-radius-md); height: 85px; margin-bottom: 10px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: var(--border-radius-md); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; animation: slideUp 0.3s ease, fadeOutToast 0.5s ease 2.5s forwards; }
        .toast.success { background: linear-gradient(45deg, #2dce89, #2dce89); }
        .toast.error { background: linear-gradient(45deg, #f5365c, #f5365c); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: scale(0.9); } }
        
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: var(--border-radius-lg); width: 90%; max-width: 500px; text-align: center; box-shadow: var(--shadow); animation: zoomIn 0.3s ease; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #camera-feed { width: 100%; max-height: 60vh; border-radius: var(--border-radius-md); margin-bottom: 15px; }
        #ocr-progress-container { margin-bottom: 10px; }
        #ocr-progress-bar { width: 100%; height: 10px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; }
        #ocr-progress-fill { width: 0%; height: 100%; background-color: var(--doan-yellow); transition: width 0.2s; }
        #ocr-status-text { font-weight: 500; color: var(--doan-blue); }

        @media (max-width: 820px) { .main-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { header { flex-direction: column; align-items: flex-start; } .date-selector { width: 100%; justify-content: space-between; } }
        @media (max-width: 600px) { .input-group { flex-direction: column; } .card { padding: 20px; } .info-grid, .dashboard-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="container">
        <header>
            <div class="header-title">
                <div class="logo">
                    <img src="https://upload.wikimedia.org/wikipedia/vi/0/09/Huy_Hi%E1%BB%87u_%C4%90o%C3%A0n.png" alt="Huy hi·ªáu ƒêo√†n">
                </div>
                <h1>B√£i xe Thanh ni√™n T√¨nh nguy·ªán</h1>
            </div>
            <div class="date-selector">
                <label for="date-picker">Xem ng√†y:</label>
                <input type="date" id="date-picker">
            </div>
        </header>

        <main class="main-grid">
            <div class="card">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/><path d="m10 12-4 4"/><path d="M12 10h6"/><path d="m14 8 2 2-2 2"/><path d="m6 14 2 2-2 2"/></svg>
                    Tra c·ª©u & X·ª≠ l√Ω
                </h2>
                <form id="main-form" autocomplete="off">
                    <div class="input-group">
                        <div class="input-wrapper">
                            <input type="text" id="search-term" placeholder="Nh·∫≠p Bi·ªÉn s·ªë xe..." required>
                        </div>
                        <button type="button" id="scan-btn" title="Qu√©t bi·ªÉn s·ªë b·∫±ng camera">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                        </button>
                    </div>
                     <div class="input-wrapper" id="phone-item-main" style="margin-bottom: 15px;">
                        <input type="tel" id="phone-number" placeholder="S·ªë ƒëi·ªán tho·∫°i (n·∫øu g·ª≠i m·ªõi)...">
                    </div>
                    <button type="submit" id="action-btn" class="action-button" disabled>Nh·∫≠p bi·ªÉn s·ªë ƒë·ªÉ ti·∫øp t·ª•c</button>
                </form>

                <div id="vehicle-info-panel">
                    <h3 style="color:white; margin-top: 20px; font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Th√¥ng tin chi ti·∫øt</h3>
                    <div class="info-grid" style="margin-top: 15px;">
                        <div class="info-item">
                            <div class="label">Tr·∫°ng th√°i</div>
                            <div class="value" id="info-status">--</div>
                        </div>
                        <div class="info-item">
                            <div class="label">Gi·ªù v√†o</div>
                            <div class="value" id="info-entry-time">--</div>
                        </div>
                        <div class="info-item" id="duration-item">
                            <div class="label">Th·ªùi gian g·ª≠i</div>
                            <div class="value info-duration" id="info-duration">--</div>
                        </div>
                    </div>
                    <h3 style="color:white; margin-top: 20px; font-size: 1rem;">L·ªãch s·ª≠ g·ª≠i xe</h3>
                    <ul class="history-list" id="info-history-list"></ul>
                </div>
            </div>

            <div class="card">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8a2 2 0 0 1 0 2.8l-6 6-3.4-3.4-3-3a2 2 0 0 1 0-2.8l6-6a2 2 0 0 1 2.8 0z"/></svg>
                    B·∫£ng tin nhanh
                </h2>
                <div class="dashboard-grid">
                    <div class="info-item">
                        <div class="label">Xe hi·ªán t·∫°i</div>
                        <div class="value" id="dashboard-current">0</div>
                    </div>
                    <div class="info-item">
                        <div class="label">T·ªïng l∆∞·ª£t trong ng√†y</div>
                        <div class="value" id="dashboard-total">0</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Gi·ªù cao ƒëi·ªÉm (v√†o)</div>
                        <div class="value" id="dashboard-peak">--</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Xe g·ª≠i l√¢u nh·∫•t</div>
                        <div class="value info-duration" id="dashboard-longest">--</div>
                    </div>
                </div>
            </div>
            
            <div class="card full-width">
                 <div class="list-header">
                    <h2 id="list-title">Danh s√°ch xe</h2>
                    <div class="input-wrapper" style="max-width: 300px;">
                         <input type="text" id="filter-input" placeholder="L·ªçc danh s√°ch theo bi·ªÉn s·ªë, SƒêT...">
                    </div>
                 </div>
                <div class="list-content">
                    <div id="vehicle-list-container"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="camera-modal" class="modal">
        <div class="modal-content">
            <h3>CƒÉn ch·ªânh bi·ªÉn s·ªë v√†o khung h√¨nh</h3>
            <video id="camera-feed" playsinline></video>
            <div id="ocr-progress-container">
                <div id="ocr-status-text">S·∫µn s√†ng qu√©t</div>
                <div id="ocr-progress-bar">
                    <div id="ocr-progress-fill"></div>
                </div>
            </div>
            <button type="button" id="capture-btn" class="action-button btn-check-in">Ch·ª•p & Qu√©t</button>
            <button type="button" id="close-camera-btn" class="action-button" style="background: #6c757d; margin-top: 10px;">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwZFTXRHo-0i2HknQAV4Ja-7lZsH27VimRnDre7DnCL2j04lkSYI1BTmCKWCvcG-0jnFg/exec';
            
            const allElements = {
                datePicker: document.getElementById('date-picker'),
                mainForm: document.getElementById('main-form'),
                searchTermInput: document.getElementById('search-term'),
                phoneNumberInput: document.getElementById('phone-number'),
                phoneItemMain: document.getElementById('phone-item-main'),
                actionBtn: document.getElementById('action-btn'),
                toastContainer: document.getElementById('toast-container'),
                vehicleInfoPanel: document.getElementById('vehicle-info-panel'),
                infoStatus: document.getElementById('info-status'),
                infoEntryTime: document.getElementById('info-entry-time'),
                infoDuration: document.getElementById('info-duration'),
                durationItem: document.getElementById('duration-item'),
                infoHistoryList: document.getElementById('info-history-list'),
                listTitle: document.getElementById('list-title'),
                vehicleListContainer: document.getElementById('vehicle-list-container'),
                filterInput: document.getElementById('filter-input'),
                dashboardCurrent: document.getElementById('dashboard-current'),
                dashboardTotal: document.getElementById('dashboard-total'),
                dashboardPeak: document.getElementById('dashboard-peak'),
                dashboardLongest: document.getElementById('dashboard-longest'),
                scanBtn: document.getElementById('scan-btn'),
                cameraModal: document.getElementById('camera-modal'),
                cameraFeed: document.getElementById('camera-feed'),
                captureBtn: document.getElementById('capture-btn'),
                closeCameraBtn: document.getElementById('close-camera-btn'),
                ocrStatusText: document.getElementById('ocr-status-text'),
                ocrProgressFill: document.getElementById('ocr-progress-fill'),
            };

            let vehiclesOnSelectedDate = [];
            let isLoading = false;
            let debounceTimer;
            let durationIntervals = [];
            let cameraStream = null;
            let currentVehicleContext = null;
            let tesseractWorker = null; // *** NEW: Persistent worker instance

            // *** NEW: Pre-load the AI worker when the page loads ***
            const initializeAI = async () => {
                showToast('ƒêang t·∫£i L√µi AI, vui l√≤ng ƒë·ª£i...');
                allElements.scanBtn.disabled = true;
                try {
                    tesseractWorker = await Tesseract.createWorker('eng', 1, {
                        logger: m => console.log(m) // Optional: for debugging
                    });
                    await tesseractWorker.setParameters({
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
                    });
                    showToast('L√µi AI ƒë√£ s·∫µn s√†ng!', 'success');
                    allElements.scanBtn.disabled = false;
                } catch (error) {
                    showToast('Kh√¥ng th·ªÉ t·∫£i L√µi AI. Vui l√≤ng ki·ªÉm tra m·∫°ng v√† t·∫£i l·∫°i trang.', 'error');
                    console.error('Tesseract worker creation failed:', error);
                }
            };
            
            const setIsLoading = (loading, actionText = 'ƒêang x·ª≠ l√Ω...') => {
                isLoading = loading;
                const interactiveElements = [allElements.actionBtn, allElements.searchTermInput, allElements.phoneNumberInput, allElements.datePicker, allElements.filterInput, allElements.captureBtn];
                // Only disable scan button if the AI worker itself is not ready
                if(tesseractWorker) allElements.scanBtn.disabled = loading;

                interactiveElements.forEach(el => { if (el) el.disabled = loading; });
                if(loading && document.activeElement.id === 'action-btn') allElements.actionBtn.textContent = actionText;
            };

            const formatDateForAPI = (date) => date.toISOString().split('T')[0];
            const formatDateTimeForDisplay = (dateStr) => dateStr ? new Date(dateStr).toLocaleString('vi-VN') : '--';
            const cleanPlateNumber = (plateStr) => plateStr ? plateStr.toUpperCase().replace(/[^A-Z0-9]/g, '') : '';
            
            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icon = type === 'success' ? '‚úÖ' : '‚ùå';
                toast.innerHTML = `${icon} <span>${message}</span>`;
                allElements.toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'fadeOutToast 0.5s ease forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 2500);
            };

            const calculateDuration = (startTime) => {
                const start = new Date(startTime);
                const now = new Date();
                let diff = Math.floor((now - start) / 1000);
                const days = Math.floor(diff / 86400); diff %= 86400;
                const hours = Math.floor(diff / 3600); diff %= 3600;
                const minutes = Math.floor(diff / 60); const seconds = diff % 60;
                let result = '';
                if (days > 0) result += `${days}d `;
                if (hours > 0) result += `${hours}h `;
                result += `${minutes}m ${seconds}s`;
                return result.trim();
            };
            const clearAllIntervals = () => {
                durationIntervals.forEach(clearInterval);
                durationIntervals = [];
            };

            const fetchVehiclesForDate = async (dateStr) => {
                if (isLoading) return;
                setIsLoading(true);
                showSkeletonLoader();
                allElements.listTitle.textContent = `Danh s√°ch xe ng√†y ${new Date(dateStr).toLocaleDateString('vi-VN')}`;
                try {
                    const response = await fetch(`${WEB_APP_URL}?date=${dateStr}`, { method: 'GET', mode: 'cors' });
                    const result = await response.json();
                    if (result.status === 'success') {
                        vehiclesOnSelectedDate = result.data;
                        filterVehicleList();
                        updateDashboard();
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showToast(`L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const fetchVehicleHistory = async (plate) => {
                if (isLoading) return;
                setIsLoading(true, 'ƒêang tra c·ª©u...');
                try {
                    const response = await fetch(`${WEB_APP_URL}?plate=${plate}`, { method: 'GET', mode: 'cors' });
                    const result = await response.json();
                    if (result.status === 'success') {
                        updateUIBasedOnHistory(plate, result.data);
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showToast(`L·ªói tra c·ª©u: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };
            
            const showSkeletonLoader = () => {
                allElements.vehicleListContainer.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const skeleton = document.createElement('div');
                    skeleton.className = 'skeleton-item';
                    allElements.vehicleListContainer.appendChild(skeleton);
                }
            };
            const renderVehicleList = (list) => {
                allElements.vehicleListContainer.innerHTML = '';
                if (list.length === 0) {
                    allElements.vehicleListContainer.innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9L2 12v9c0 .6.4 1 1 1h2"/><path d="M7 12V2H3v10"/><path d="m16 12 3.1 3.9c.1.1.1.3 0 .4l-1.1.9c-.1.1-.3.1-.4 0L16 16v-4"/><path d="M5 18h3"/><path d="M6 18v-4"/></svg><p>Kh√¥ng c√≥ xe n√†o trong danh s√°ch.</p></div>`;
                    return;
                }
                list.sort((a, b) => new Date(b.entryTime) - new Date(a.entryTime));
                list.forEach(vehicle => {
                    const vehicleItem = document.createElement('div');
                    vehicleItem.className = 'vehicle-item';
                    const phoneInfo = vehicle.phone ? `<span>üìû ${vehicle.phone}</span>` : '';
                    const statusClass = vehicle.status === 'ƒêang g·ª≠i' ? 'parking' : 'departed';
                    const statusBadge = `<span class="status-badge ${statusClass}">${vehicle.status}</span>`;
                    const carIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19.94,10.25a2.5,2.5,0,0,0-4.88,0H4.06a2.5,2.5,0,0,0-4.88,0H0v10H24V10.25ZM6,14.75a1.5,1.5,0,1,1,1.5,1.5A1.5,1.5,0,0,1,6,14.75Zm12,0a1.5,1.5,0,1,1,1.5,1.5A1.5,1.5,0,0,1,18,14.75Z"/></svg>`;
                    vehicleItem.innerHTML = `<div class="icon">${carIcon}</div><div class="info"><div class="plate">${vehicle.plate} ${statusBadge}</div><div class="details">${phoneInfo}<span>üïí ${formatDateTimeForDisplay(vehicle.entryTime)}</span></div></div>`;
                    allElements.vehicleListContainer.appendChild(vehicleItem);
                });
            };
            const filterVehicleList = () => {
                const filterText = cleanPlateNumber(allElements.filterInput.value);
                if (!filterText) { renderVehicleList(vehiclesOnSelectedDate); return; }
                const filteredList = vehiclesOnSelectedDate.filter(v => 
                    cleanPlateNumber(v.plate).includes(filterText) || (v.phone && v.phone.includes(filterText))
                );
                renderVehicleList(filteredList);
            };
            const updateDashboard = () => {
                const currentVehicles = vehiclesOnSelectedDate.filter(v => v.status === 'ƒêang g·ª≠i');
                allElements.dashboardCurrent.textContent = currentVehicles.length;
                allElements.dashboardTotal.textContent = vehiclesOnSelectedDate.length;
                if (vehiclesOnSelectedDate.length > 0) {
                    const hours = vehiclesOnSelectedDate.map(v => new Date(v.entryTime).getHours());
                    const hourCounts = hours.reduce((acc, hour) => { acc[hour] = (acc[hour] || 0) + 1; return acc; }, {});
                    const peakHour = Object.keys(hourCounts).length > 0 ? Object.keys(hourCounts).reduce((a, b) => hourCounts[a] > hourCounts[b] ? a : b) : '--';
                    allElements.dashboardPeak.textContent = peakHour !== '--' ? `${peakHour}h - ${parseInt(peakHour) + 1}h` : '--';
                } else { allElements.dashboardPeak.textContent = '--'; }
                if (currentVehicles.length > 0) {
                    const longest = currentVehicles.reduce((a, b) => new Date(a.entryTime) < new Date(b.entryTime) ? a : b);
                    allElements.dashboardLongest.textContent = calculateDuration(longest.entryTime);
                } else { allElements.dashboardLongest.textContent = '--'; }
            };

            const updateUIBasedOnHistory = (plate, history) => {
                clearAllIntervals();
                currentVehicleContext = { plate, history };
                const currentEntry = history.find(entry => entry.status === 'ƒêang g·ª≠i');
                
                if (currentEntry) {
                    currentVehicleContext.status = 'parking';
                    allElements.vehicleInfoPanel.style.display = 'block';
                    allElements.phoneItemMain.style.display = 'none';
                    allElements.infoStatus.innerHTML = `<span class="status-badge parking">ƒêang g·ª≠i</span>`;
                    allElements.infoEntryTime.textContent = formatDateTimeForDisplay(currentEntry.entryTime);
                    allElements.durationItem.style.display = 'block';
                    const interval = setInterval(() => allElements.infoDuration.textContent = calculateDuration(currentEntry.entryTime), 1000);
                    durationIntervals.push(interval);
                    allElements.actionBtn.textContent = 'X√°c nh·∫≠n cho xe ra';
                    allElements.actionBtn.className = 'action-button btn-check-out';
                } else {
                    currentVehicleContext.status = 'new';
                    allElements.vehicleInfoPanel.style.display = history.length > 0 ? 'block' : 'none';
                    allElements.phoneItemMain.style.display = 'block';
                    allElements.infoStatus.innerHTML = `<span class="status-badge not-parking">Ngo√†i b√£i</span>`;
                    allElements.infoEntryTime.textContent = '--';
                    allElements.durationItem.style.display = 'none';
                    allElements.phoneNumberInput.value = history[0]?.phone || '';
                    allElements.actionBtn.textContent = 'X√°c nh·∫≠n g·ª≠i xe';
                    allElements.actionBtn.className = 'action-button btn-check-in';
                }
                const historyList = allElements.infoHistoryList; historyList.innerHTML = '';
                if (history.length > 0) {
                    history.slice(0, 5).forEach(entry => {
                        const li = document.createElement('li'); li.className = 'history-item';
                        li.innerHTML = `<span>‚ñ∂Ô∏è <strong>V√†o:</strong> ${formatDateTimeForDisplay(entry.entryTime)}</span><span>‚óÄÔ∏è <strong>Ra:</strong> ${formatDateTimeForDisplay(entry.exitTime)}</span>`;
                        historyList.appendChild(li);
                    });
                } else { historyList.innerHTML = `<li class="history-item">Ch∆∞a c√≥ l·ªãch s·ª≠.</li>`; }
                allElements.actionBtn.disabled = false;
            };

            const resetMainForm = () => {
                allElements.vehicleInfoPanel.style.display = 'none';
                allElements.phoneItemMain.style.display = 'block';
                allElements.actionBtn.disabled = true;
                allElements.actionBtn.textContent = 'Nh·∫≠p bi·ªÉn s·ªë ƒë·ªÉ ti·∫øp t·ª•c';
                allElements.actionBtn.className = 'action-button';
                currentVehicleContext = null;
                clearAllIntervals();
            };

            const handleVehicleAction = async (plate, phone, action) => {
                if (isLoading) return;
                plate = cleanPlateNumber(plate);
                if(!plate) { showToast("Bi·ªÉn s·ªë kh√¥ng h·ª£p l·ªá.", 'error'); return; }
                setIsLoading(true, 'ƒêang g·ª≠i...');
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ plate, phone, action })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showToast(result.message, 'success');
                        allElements.mainForm.reset();
                        resetMainForm();
                        await fetchVehiclesForDate(allElements.datePicker.value);
                    } else { throw new Error(result.message); }
                } catch (error) {
                    showToast(`L·ªói: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const openCamera = async () => {
                if (!tesseractWorker) {
                    showToast('L√µi AI ch∆∞a s·∫µn s√†ng, vui l√≤ng ƒë·ª£i.', 'error');
                    return;
                }
                if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
                    showToast('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ camera.', 'error');
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    allElements.cameraFeed.srcObject = stream;
                    cameraStream = stream;
                    allElements.cameraModal.style.display = 'flex';
                    allElements.cameraFeed.play();
                } catch(err) {
                    showToast('Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng c·∫•p quy·ªÅn.', 'error');
                    console.error(err);
                }
            };

            const closeCamera = () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                allElements.cameraModal.style.display = 'none';
            };
            
            const performOcrScan = async () => {
                if (!cameraStream || isLoading || !tesseractWorker) return;
                setIsLoading(true, 'ƒêang qu√©t...');
                
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = allElements.cameraFeed.videoWidth;
                    canvas.height = allElements.cameraFeed.videoHeight;
                    canvas.getContext('2d').drawImage(allElements.cameraFeed, 0, 0, canvas.width, canvas.height);
                    
                    const result = await tesseractWorker.recognize(canvas);
                    
                    let plate = cleanPlateNumber(result.data.text);
                    
                    if (plate.length >= 6 && plate.length <= 9) {
                        allElements.searchTermInput.value = plate;
                        showToast(`Nh·∫≠n di·ªán: ${plate}`, 'success');
                        allElements.searchTermInput.dispatchEvent(new Event('input', { bubbles: true }));
                    } else {
                        showToast("Kh√¥ng nh·∫≠n di·ªán r√µ r√†ng, th·ª≠ l·∫°i ho·∫∑c ch·ª•p g·∫ßn bi·ªÉn s·ªë.", "error");
                    }
                } catch (error) {
                    showToast("C√≥ l·ªói khi nh·∫≠n di·ªán bi·ªÉn s·ªë.", "error");
                    console.error(error);
                } finally {
                    setIsLoading(false);
                    closeCamera();
                }
            };

            // Event Listeners
            allElements.datePicker.addEventListener('change', () => fetchVehiclesForDate(allElements.datePicker.value));
            allElements.mainForm.addEventListener('submit', (e) => {
                e.preventDefault();
                let plateToSubmit = cleanPlateNumber(allElements.searchTermInput.value);
                let phoneToSubmit = allElements.phoneNumberInput.value.trim();
                let action;

                if (currentVehicleContext) {
                    plateToSubmit = currentVehicleContext.plate;
                    if (currentVehicleContext.status === 'parking') {
                        action = 'checkOut';
                        phoneToSubmit = '';
                    } else {
                        action = 'checkIn';
                    }
                } else {
                     action = 'checkIn';
                }
                handleVehicleAction(plateToSubmit, phoneToSubmit, action);
            });
            allElements.searchTermInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const plate = cleanPlateNumber(allElements.searchTermInput.value);
                if (plate.length >= 6) {
                    debounceTimer = setTimeout(() => fetchVehicleHistory(plate), 500);
                } else {
                    resetMainForm();
                }
            });
            allElements.filterInput.addEventListener('input', filterVehicleList);
            allElements.scanBtn.addEventListener('click', openCamera);
            allElements.closeCameraBtn.addEventListener('click', closeCamera);
            allElements.captureBtn.addEventListener('click', performOcrScan);
            
            // --- INITIALIZATION ---
            constinitializeApp = async () => {
                await initializeAI();
                allElements.datePicker.value = formatDateForAPI(new Date());
                fetchVehiclesForDate(allElements.datePicker.value);
                resetMainForm();
            }

            initializeApp();
        });
    </script>
</body>
</html>

